# repair_ultimate.py
import os
import shutil
import sys
import subprocess

def clean_project():
    """Nettoie complètement le projet"""
    print("=== NETTOYAGE COMPLET DU PROJET ===")
    
    # 1. Arrêter le serveur
    subprocess.run("pkill -f 'python manage.py runserver'", shell=True, capture_output=True)
    
    # 2. Supprimer les migrations
    print("\n1. Nettoyage des migrations...")
    migrations_dirs = [
        "membres/migrations/",
        "agents/migrations/", 
        "assureur/migrations/",
        "medecin/migrations/",
    ]
    
    for dir_path in migrations_dirs:
        if os.path.exists(dir_path):
            shutil.rmtree(dir_path)
            print(f"  Supprimé: {dir_path}")
        os.makedirs(dir_path, exist_ok=True)
        with open(os.path.join(dir_path, "__init__.py"), "w") as f:
            f.write("")
    
    # 3. Supprimer la base de données
    print("\n2. Nettoyage de la base de données...")
    db_files = ["db.sqlite3", "db.sqlite3-journal"]
    for db_file in db_files:
        if os.path.exists(db_file):
            os.remove(db_file)
            print(f"  Supprimé: {db_file}")
    
    # 4. Nettoyer les caches Python
    print("\n3. Nettoyage des caches...")
    for root, dirs, files in os.walk("."):
        for dir_name in dirs:
            if dir_name == "__pycache__":
                dir_path = os.path.join(root, dir_name)
                shutil.rmtree(dir_path, ignore_errors=True)
                print(f"  Supprimé: {dir_path}")
        for file_name in files:
            if file_name.endswith(".pyc"):
                file_path = os.path.join(root, file_name)
                os.remove(file_path)
                print(f"  Supprimé: {file_path}")

def fix_forms_file():
    """Corrige le fichier forms.py problématique"""
    forms_path = "assureur/forms.py"
    if not os.path.exists(forms_path):
        return
    
    print("\n4. Correction du fichier forms.py...")
    
    # Lire le contenu
    with open(forms_path, 'r') as f:
        content = f.read()
    
    # Corriger RechercheMembreForm (ligne ~440)
    old_line_1 = "choices=[('', 'Tous les statuts')] + [(s, s) for s in Membre.objects.values_list('statut', flat=True).distinct()],"
    new_line_1 = "choices=[('', 'Tous les statuts'), ('actif', 'Actif'), ('en_retard', 'En retard de paiement'), ('inactif', 'Inactif')],"
    
    # Corriger FiltreBonsForm (ligne ~450)
    old_line_2 = "choices=[('', 'Tous les statuts')] + [(s, s) for s in Bon.objects.values_list('statut', flat=True).distinct()],"
    new_line_2 = "choices=[('', 'Tous les statuts'), ('BROUILLON', 'Brouillon'), ('ATTENTE', 'En attente de validation'), ('VALIDE', 'Validé'), ('REFUSE', 'Refusé'), ('REMBOURSE', 'Remboursé'), ('ANNULE', 'Annulé')],"
    
    if old_line_1 in content:
        content = content.replace(old_line_1, new_line_1)
        print("  ✓ RechercheMembreForm corrigé")
    
    if old_line_2 in content:
        content = content.replace(old_line_2, new_line_2)
        print("  ✓ FiltreBonsForm corrigé")
    
    # Sauvegarder
    with open(forms_path, 'w') as f:
        f.write(content)

def create_minimal_migration():
    """Crée une migration minimale pour membres"""
    print("\n5. Création d'une migration minimale...")
    
    migration_content = '''# Generated by Django
from django.db import migrations, models
import django.db.models.deletion
import django.utils.timezone


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='Membre',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('numero_unique', models.CharField(editable=False, max_length=20, unique=True)),
                ('nom', models.CharField(max_length=100)),
                ('prenom', models.CharField(max_length=100)),
                ('telephone', models.CharField(blank=True, default='', max_length=15)),
                ('numero_urgence', models.CharField(blank=True, default='', max_length=15)),
                ('date_inscription', models.DateTimeField(default=django.utils.timezone.now)),
                ('statut', models.CharField(choices=[('actif', 'Actif'), ('en_retard', 'En retard de paiement'), ('inactif', 'Inactif')], default='actif', max_length=20)),
                ('categorie', models.CharField(choices=[('standard', 'Standard'), ('femme_enceinte', 'Femme enceinte'), ('enfant', 'Enfant'), ('senior', 'Senior')], default='standard', max_length=20)),
                ('date_naissance', models.DateField(blank=True, null=True)),
                ('adresse', models.TextField(blank=True, default='')),
                ('email', models.EmailField(blank=True, default='', max_length=254)),
                ('profession', models.CharField(blank=True, default='', max_length=100)),
                ('date_derniere_cotisation', models.DateField(blank=True, null=True)),
                ('prochain_paiement_le', models.DateField(blank=True, null=True)),
            ],
            options={
                'verbose_name': 'Membre',
                'verbose_name_plural': 'Membres',
                'ordering': ['nom', 'prenom'],
            },
        ),
    ]
    '''
    
    migration_dir = "membres/migrations"
    migration_file = os.path.join(migration_dir, "0001_initial.py")
    
    with open(migration_file, 'w') as f:
        f.write(migration_content)
    
    print(f"  ✓ Migration créée: {migration_file}")

def run_django_command(cmd, description):
    """Exécute une commande Django"""
    print(f"\n{description}...")
    print(f"  Commande: {cmd}")
    
    env = os.environ.copy()
    env['PYTHONPATH'] = os.getcwd()
    
    result = subprocess.run(
        cmd,
        shell=True,
        capture_output=True,
        text=True,
        env=env
    )
    
    if result.returncode == 0:
        print(f"  ✓ Succès")
        if result.stdout.strip():
            print(f"  Output: {result.stdout[:200]}...")
        return True
    else:
        print(f"  ✗ Échec")
        if result.stderr:
            print(f"  Erreur: {result.stderr[:500]}...")
        return False

def main():
    print("=" * 60)
    print("RÉPARATION ULTIME DES MIGRATIONS DJANGO")
    print("=" * 60)
    
    # 1. Nettoyage
    clean_project()
    
    # 2. Correction des fichiers
    fix_forms_file()
    
    # 3. Créer migration minimale
    create_minimal_migration()
    
    # 4. Créer migrations pour autres apps (vides)
    for app in ["agents", "assureur", "medecin"]:
        migration_dir = f"{app}/migrations"
        migration_file = os.path.join(migration_dir, "0001_initial.py")
        with open(migration_file, 'w') as f:
            f.write(f'''# Generated by Django
from django.db import migrations

class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
    ]
    ''')
        print(f"  ✓ Migration vide créée pour {app}")
    
    # 5. Appliquer les migrations de base
    print("\n6. Application des migrations...")
    
    # D'abord migrer les apps Django de base
    base_apps = ["auth", "contenttypes", "sessions", "admin"]
    for app in base_apps:
        run_django_command(f"python -c \"from django.core.management import execute_from_command_line; execute_from_command_line(['manage.py', 'migrate', '{app}', '--fake'])\"", f"Migration {app}")
    
    # Puis migrer membres
    run_django_command("python manage.py migrate membres", "Migration membres")
    
    # Puis les autres apps
    for app in ["agents", "assureur", "medecin"]:
        run_django_command(f"python manage.py migrate {app} --fake", f"Migration {app}")
    
    # 6. Créer un superutilisateur
    print("\n7. Création d'un superutilisateur...")
    create_superuser_cmd = '''python manage.py shell -c "
from django.contrib.auth import get_user_model
User = get_user_model()
try:
    if not User.objects.filter(username='admin').exists():
        User.objects.create_superuser('admin', 'admin@example.com', 'admin123')
        print('Superutilisateur créé: admin / admin123')
    else:
        print('Superutilisateur existe déjà')
except Exception as e:
    print(f'Erreur création superutilisateur: {e}')
"'''
    
    run_django_command(create_superuser_cmd, "Création superutilisateur")
    
    print("\n" + "=" * 60)
    print("RÉPARATION TERMINÉE !")
    print("=" * 60)
    print("\nVous pouvez maintenant démarrer le serveur avec:")
    print("python manage.py runserver")
    print("\nSi des erreurs persistent, exécutez:")
    print("python manage.py check --deploy")
    print("\nPour créer d'autres utilisateurs:")
    print("python manage.py createsuperuser")

if __name__ == "__main__":
    main()