<!-- templates/agents/verification_cotisations.html - VERSION COMPL√àTEMENT CORRIG√âE -->
{% extends 'agents/base_agent.html' %}
{% load static %}

{% block title %}V√©rification cotisations - Agent{% endblock %}
{% block page_title %}V√©rification des cotisations{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8">
            <!-- Carte principale de v√©rification -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-check-circle me-2"></i>V√©rification en temps r√©el
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Recherche rapide -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Rechercher un membre</label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control" id="rechercheMembreRapide" 
                                   placeholder="Nom, pr√©nom, num√©ro de membre ou t√©l√©phone...">
                            <button class="btn btn-primary" type="button" id="btnRechercheRapide">
                                <i class="fas fa-search me-1"></i>Rechercher
                            </button>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Saisissez au moins 2 caract√®res pour lancer la recherche
                        </div>
                        <div id="resultatsRechercheRapide" class="mt-3"></div>
                    </div>

                    <!-- R√©sultats de v√©rification -->
                    <div id="resultatsVerification" class="mt-4">
                        <div class="alert alert-info border-start border-info border-4">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-info-circle fa-2x me-3 text-info"></i>
                                <div>
                                    <h5 class="alert-heading mb-2">Bienvenue dans le module de v√©rification</h5>
                                    <p class="mb-0">
                                        Utilisez la recherche ci-dessus pour v√©rifier les cotisations des membres.<br>
                                        Le syst√®me affichera le statut de cotisation en temps r√©el.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recherche avanc√©e -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-search-plus me-2"></i>Recherche avanc√©e
                    </h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="{% url 'agents:recherche_cotisations_avancee' %}">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Nom</label>
                                <input type="text" class="form-control" name="nom" placeholder="Nom du membre">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Pr√©nom</label>
                                <input type="text" class="form-control" name="prenom" placeholder="Pr√©nom du membre">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Num√©ro de membre</label>
                                <input type="text" class="form-control" name="numero_unique" placeholder="Num√©ro unique">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">T√©l√©phone</label>
                                <input type="text" class="form-control" name="telephone" placeholder="Num√©ro de t√©l√©phone">
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-outline-primary">
                                    <i class="fas fa-search me-1"></i>Recherche avanc√©e
                                </button>
                                <a href="{% url 'agents:liste_membres' %}" class="btn btn-outline-secondary ms-2">
                                    <i class="fas fa-list me-1"></i>Voir tous les membres
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Statistiques de l'agent -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Mes statistiques
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="avatar-circle bg-primary text-white mx-auto mb-3">
                            <i class="fas fa-user-tie fa-2x"></i>
                        </div>
                        <h5 class="mb-1">{{ agent.user.get_full_name|default:agent.user.username }}</h5>
                        <p class="text-muted mb-0">{{ agent.poste|default:"Agent" }}</p>
                    </div>
                    
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="stat-card bg-light rounded p-3">
                                <h3 class="text-primary mb-1">{{ verifications_du_jour }}</h3>
                                <small class="text-muted">Aujourd'hui</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="stat-card bg-light rounded p-3">
                                <h3 class="text-success mb-1">{{ agent.limite_bons_quotidienne|default:"10" }}</h3>
                                <small class="text-muted">Bons/jour</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <small class="text-muted d-block">
                            <i class="fas fa-id-card me-1"></i>
                            Matricule: <strong>{{ agent.matricule|default:"N/A" }}</strong>
                        </small>
                        <small class="text-muted d-block mt-1">
                            <i class="fas fa-calendar me-1"></i>
                            Connect√© le {% now "d/m/Y" %}
                        </small>
                    </div>
                </div>
            </div>

            <!-- Derni√®res v√©rifications -->
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>Activit√© r√©cente
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if dernieres_verifications %}
                    <div class="list-group list-group-flush">
                        {% for verif in dernieres_verifications %}
                        <div class="list-group-item px-3 py-3">
                            <div class="d-flex w-100 justify-content-between align-items-start mb-2">
                                <h6 class="mb-0 fw-bold">{{ verif.membre.prenom }} {{ verif.membre.nom }}</h6>
                                <span class="badge {% if verif.statut_cotisation == 'a_jour' %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ verif.statut_cotisation|default:"Non v√©rifi√©" }}
                                </span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    {{ verif.date_verification|date:"d/m/Y H:i" }}
                                </small>
                                {% if verif.jours_retard and verif.jours_retard > 0 %}
                                <small class="text-danger">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    {{ verif.jours_retard }}j retard
                                </small>
                                {% endif %}
                            </div>
                            <div class="mt-2">
                                <a href="{% url 'agents:fiche_cotisation_unifiee' verif.membre.id %}" 
                                   class="btn btn-sm btn-outline-primary" target="_blank">
                                    <i class="fas fa-file-alt me-1"></i>Fiche
                                </a>
                                <a href="{% url 'agents:creer_bon_soin_membre' verif.membre.id %}" 
                                   class="btn btn-sm btn-outline-success ms-1">
                                    <i class="fas fa-file-medical me-1"></i>Bon
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-0">Aucune v√©rification r√©cente</p>
                        <small class="text-muted">Les v√©rifications appara√Ætront ici</small>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer bg-light">
                    <small class="text-muted">
                        <i class="fas fa-sync-alt me-1"></i>
                        Mise √† jour automatique
                    </small>
                </div>
            </div>

            <!-- Actions rapides -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>Actions rapides
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'agents:creer_membre' %}" class="btn btn-outline-primary">
                            <i class="fas fa-user-plus me-2"></i>Nouveau membre
                        </a>
                        <a href="{% url 'agents:creer_bon_soin' %}" class="btn btn-outline-success">
                            <i class="fas fa-file-medical me-2"></i>Cr√©er bon de soin
                        </a>
                        <a href="{% url 'agents:liste_membres' %}" class="btn btn-outline-info">
                            <i class="fas fa-list me-2"></i>Liste des membres
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.avatar-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.stat-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.list-group-item {
    transition: background-color 0.2s ease;
    border: none;
    border-bottom: 1px solid #eee;
}

.list-group-item:last-child {
    border-bottom: none;
}

.list-group-item:hover {
    background-color: #f8f9fa;
}

.card {
    border: none;
    border-radius: 10px;
}

.card-header {
    border-radius: 10px 10px 0 0 !important;
}

.input-group-text {
    border: none;
    background-color: #f8f9fa;
}

.form-control:focus {
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    border-color: #80bdff;
}

.badge {
    font-size: 0.75em;
    padding: 0.35em 0.65em;
}

.btn {
    border-radius: 6px;
    font-weight: 500;
}

.alert {
    border: none;
    border-radius: 8px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let rechercheTimeout = null;
let membreSelectionne = null;

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ Module de v√©rification des cotisations initialis√©');
    
    // Focus automatique sur la recherche
    document.getElementById('rechercheMembreRapide').focus();
    
    // Configuration des √©v√©nements
    initialiserEvenements();
});

function initialiserEvenements() {
    // Recherche au clic
    document.getElementById('btnRechercheRapide').addEventListener('click', function() {
        clearTimeout(rechercheTimeout);
        rechercherMembre();
    });

    // Recherche en temps r√©el
    document.getElementById('rechercheMembreRapide').addEventListener('input', function(e) {
        clearTimeout(rechercheTimeout);
        const query = this.value.trim();
        
        if (query.length === 0) {
            document.getElementById('resultatsRechercheRapide').innerHTML = '';
            return;
        }
        
        rechercheTimeout = setTimeout(() => {
            if (query.length >= 2) {
                rechercherMembre();
            } else {
                document.getElementById('resultatsRechercheRapide').innerHTML = 
                    '<div class="alert alert-warning">Entrez au moins 2 caract√®res</div>';
            }
        }, 500);
    });

    // Recherche avec Entr√©e
    document.getElementById('rechercheMembreRapide').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            clearTimeout(rechercheTimeout);
            rechercherMembre();
        }
    });
}

function rechercherMembre() {
    const query = document.getElementById('rechercheMembreRapide').value.trim();
    const resultsDiv = document.getElementById('resultatsRechercheRapide');
    
    if (query.length < 2) {
        resultsDiv.innerHTML = '<div class="alert alert-warning">Entrez au moins 2 caract√®res</div>';
        return;
    }

    // Affichage du loading
    resultsDiv.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-2 text-muted">Recherche en cours...</p>
        </div>
    `;

    // URL de l'API - CORRECTION: Utiliser l'URL correcte
    const apiUrl = `/agents/api/recherche-membres/?q=${encodeURIComponent(query)}`;
    
    fetch(apiUrl, {
        method: 'GET',
        headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        afficherResultatsRecherche(data);
    })
    .catch(error => {
        console.error('‚ùå Erreur recherche:', error);
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle me-3 fa-2x"></i>
                    <div>
                        <h6 class="alert-heading mb-1">Erreur de connexion</h6>
                        <p class="mb-0">Impossible d'acc√©der au service de recherche.</p>
                        <small class="text-muted">D√©tail: ${escapeHtml(error.message)}</small>
                    </div>
                </div>
            </div>
        `;
    });
}

function afficherResultatsRecherche(data) {
    const resultsDiv = document.getElementById('resultatsRechercheRapide');
    
    if (!data || !data.membres || data.membres.length === 0) {
        resultsDiv.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Aucun membre trouv√© pour cette recherche.
            </div>
        `;
        return;
    }

    let html = '<div class="list-group">';
    
    data.membres.forEach(membre => {
        const estAJour = membre.est_a_jour || false;
        const nomComplet = membre.nom_complet || `${membre.prenom || ''} ${membre.nom || ''}`.trim();
        const numeroMembre = membre.numero_unique || membre.numero_membre || 'N/A';
        const telephone = membre.telephone || 'Non renseign√©';
        
        html += `
            <div class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between align-items-start">
                    <div class="flex-grow-1 me-3">
                        <h6 class="mb-1 fw-bold">${escapeHtml(nomComplet)}</h6>
                        <p class="mb-1 text-muted small">
                            <i class="fas fa-hashtag me-1"></i>${escapeHtml(numeroMembre)}<br>
                            <i class="fas fa-phone me-1"></i>${escapeHtml(telephone)}
                        </p>
                    </div>
                    <div class="text-end">
                        <span class="badge ${estAJour ? 'bg-success' : 'bg-danger'} mb-2">
                            ${estAJour ? '√Ä jour' : 'En retard'}
                        </span>
                        <div>
                            <button class="btn btn-sm btn-primary verifier-membre" 
                                    data-membre-id="${membre.id}"
                                    data-membre-nom="${escapeHtml(nomComplet)}">
                                <i class="fas fa-check-circle me-1"></i>V√©rifier
                            </button>
                            <a href="/agents/fiche-cotisation-unifiee/${membre.id}/" 
                               class="btn btn-sm btn-outline-info ms-1" target="_blank"
                               title="Voir fiche d√©taill√©e">
                                <i class="fas fa-file-alt"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    resultsDiv.innerHTML = html;
    
    // Ajouter les √©v√©nements aux boutons de v√©rification
    document.querySelectorAll('.verifier-membre').forEach(button => {
        button.addEventListener('click', function() {
            const membreId = this.getAttribute('data-membre-id');
            const membreNom = this.getAttribute('data-membre-nom');
            membreSelectionne = { id: membreId, nom: membreNom };
            verifierCotisation(membreId, membreNom);
        });
    });
}

function verifierCotisation(membreId, membreNom) {
    const resultsDiv = document.getElementById('resultatsVerification');
    
    // Affichage du loading
    resultsDiv.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">V√©rification en cours...</span>
            </div>
            <h5 class="text-primary">V√©rification en cours</h5>
            <p class="text-muted">Veuillez patienter pendant la v√©rification de ${escapeHtml(membreNom)}</p>
        </div>
    `;

    // URL de l'API de v√©rification - CORRECTION: Utiliser l'URL correcte
    const apiUrl = `/agents/api/verifier-cotisation/${membreId}/`;
    
    fetch(apiUrl, {
        method: 'GET',
        headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        afficherResultatVerification(data, membreNom);
    })
    .catch(error => {
        console.error('‚ùå Erreur v√©rification:', error);
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <div class="d-flex align-items-center">
                    <i class="fas fa-network-wired me-3 fa-2x"></i>
                    <div>
                        <h5 class="alert-heading mb-2">Erreur de connexion</h5>
                        <p class="mb-2">Impossible de v√©rifier la cotisation pour le moment.</p>
                        <small class="text-muted">D√©tail: ${escapeHtml(error.message)}</small>
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-primary" onclick="verifierCotisation('${membreId}', '${escapeHtml(membreNom)}')">
                                <i class="fas fa-redo me-1"></i>R√©essayer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
}

function afficherResultatVerification(data, membreNom) {
    const resultsDiv = document.getElementById('resultatsVerification');
    
    if (data.success) {
        const estAJour = data.est_a_jour;
        const alertType = estAJour ? 'success' : 'warning';
        const icon = estAJour ? 'check-circle' : 'exclamation-triangle';
        const titre = estAJour ? 'Cotisation √† jour' : 'Attention: Cotisation en retard';
        
        let detailsHtml = '';
        
        if (data.jours_retard && data.jours_retard > 0) {
            detailsHtml += `
                <div class="mb-2">
                    <strong><i class="fas fa-calendar-times me-1 text-danger"></i>Jours de retard:</strong> 
                    <span class="text-danger fw-bold">${data.jours_retard} jours</span>
                </div>
            `;
        }
        
        if (data.dernier_paiement) {
            detailsHtml += `
                <div class="mb-2">
                    <strong><i class="fas fa-money-bill-wave me-1 text-success"></i>Dernier paiement:</strong> 
                    ${escapeHtml(data.dernier_paiement)}
                </div>
            `;
        }
        
        if (data.prochaine_echeance) {
            detailsHtml += `
                <div class="mb-2">
                    <strong><i class="fas fa-calendar-check me-1 text-info"></i>Prochaine √©ch√©ance:</strong> 
                    ${escapeHtml(data.prochaine_echeance)}
                </div>
            `;
        }
        
        if (data.montant_du) {
            detailsHtml += `
                <div class="mb-2">
                    <strong><i class="fas fa-coins me-1 text-warning"></i>Montant d√ª:</strong> 
                    <span class="fw-bold">${escapeHtml(data.montant_du)}</span>
                </div>
            `;
        }
        
        resultsDiv.innerHTML = `
            <div class="alert alert-${alertType} border-${alertType} border-start border-4">
                <div class="d-flex align-items-start">
                    <i class="fas fa-${icon} fa-2x me-3 mt-1 text-${alertType}"></i>
                    <div class="flex-grow-1">
                        <h4 class="alert-heading mb-3">${titre}</h4>
                        <h5 class="mb-3">${escapeHtml(membreNom)}</h5>
                        <p class="mb-3 lead">${escapeHtml(data.message)}</p>
                        ${detailsHtml}
                        <hr>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                V√©rifi√© le ${new Date().toLocaleString('fr-FR')}
                                ${data.verification_id ? ` | ID: ${data.verification_id}` : ''}
                            </small>
                            <div>
                                <a href="/agents/fiche-cotisation-unifiee/${membreSelectionne.id}/" 
                                   class="btn btn-sm btn-outline-info" target="_blank">
                                    <i class="fas fa-file-alt me-1"></i>Fiche d√©taill√©e
                                </a>
                                <a href="/agents/creer-bon-soin/${membreSelectionne.id}/" 
                                   class="btn btn-sm btn-${estAJour ? 'success' : 'warning'} ms-1">
                                    <i class="fas fa-file-medical me-1"></i>Cr√©er bon
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else {
        resultsDiv.innerHTML = `
            <div class="alert alert-danger border-danger border-start border-4">
                <div class="d-flex align-items-center">
                    <i class="fas fa-times-circle fa-2x me-3"></i>
                    <div>
                        <h5 class="alert-heading mb-2">Erreur lors de la v√©rification</h5>
                        <p class="mb-0">${escapeHtml(data.error || 'Erreur inconnue lors de la v√©rification')}</p>
                    </div>
                </div>
            </div>
        `;
    }
}

// Fonction utilitaire pour √©chapper le HTML
function escapeHtml(unsafe) {
    if (unsafe === null || unsafe === undefined) return '';
    return unsafe
        .toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// Fonction pour rafra√Æchir les statistiques
function rafraichirStatistiques() {
    // Impl√©mentation future pour rafra√Æchir les stats en temps r√©el
    console.log('üîÑ Rafra√Æchissement des statistiques...');
}

// Auto-rafra√Æchissement optionnel (toutes les 30 secondes)
setInterval(() => {
    if (document.visibilityState === 'visible') {
        rafraichirStatistiques();
    }
}, 30000);
</script>
{% endblock %}