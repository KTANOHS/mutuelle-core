#!/usr/bin/env python3
"""
SOLUTION COMPL√àTE - Correction du modal avec tous les destinataires
"""

import os
import django
from pathlib import Path

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'mutuelle_core.settings')
django.setup()

BASE_DIR = Path(__file__).parent

def fix_nouveau_message_button():
    """Corrige compl√®tement le bouton nouveau message avec tous les destinataires"""
    
    # 1. Cr√©er le nouveau modal fonctionnel avec tous les destinataires
    new_modal_content = '''<!-- NOUVEAU MODAL FONCTIONNEL AVEC TOUS LES DESTINATAIRES -->
<div class="modal fade" id="nouveauMessageModal" tabindex="-1" aria-labelledby="nouveauMessageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="nouveauMessageModalLabel">
                    <i class="fas fa-plus me-2"></i>Nouveau Message
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="messageForm">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="destinataire" class="form-label fw-bold">Destinataire</label>
                        <select class="form-select" id="destinataire" name="destinataire" required>
                            <option value="">S√©lectionnez un destinataire...</option>
                            <option value="assureur">Assureur</option>
                            <option value="membre">Membre</option>
                            <option value="agent">Agent</option>
                            <option value="medecin">M√©decin</option>
                            <option value="pharmacien">Pharmacien</option>
                            <option value="administration">Administration</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="sujet" class="form-label fw-bold">Sujet</label>
                        <input type="text" class="form-control" id="sujet" name="sujet" placeholder="Sujet du message" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="message" class="form-label fw-bold">Message</label>
                        <textarea class="form-control" id="message" name="message" rows="6" 
                                  placeholder="Tapez votre message ici..." required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Annuler
                </button>
                <button type="button" class="btn btn-primary" onclick="envoyerMessage()">
                    <i class="fas fa-paper-plane me-1"></i>Envoyer le message
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function envoyerMessage() {
    const form = document.getElementById('messageForm');
    const destinataire = document.getElementById('destinataire').value;
    const sujet = document.getElementById('sujet').value;
    const message = document.getElementById('message').value;
    
    // Validation
    if (!destinataire) {
        alert('‚ö†Ô∏è Veuillez s√©lectionner un destinataire');
        return;
    }
    
    if (!sujet.trim()) {
        alert('‚ö†Ô∏è Veuillez saisir un sujet');
        return;
    }
    
    if (!message.trim()) {
        alert('‚ö†Ô∏è Veuillez saisir un message');
        return;
    }
    
    console.log('üì§ Envoi du message...', {
        destinataire: destinataire,
        sujet: sujet,
        message: message
    });
    
    // Simulation d'envoi avec feedback visuel
    const btnEnvoyer = document.querySelector('#nouveauMessageModal .btn-primary');
    const originalText = btnEnvoyer.innerHTML;
    btnEnvoyer.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Envoi en cours...';
    btnEnvoyer.disabled = true;
    
    // Simulation d'envoi au serveur
    setTimeout(() => {
        // R√©activer le bouton
        btnEnvoyer.innerHTML = originalText;
        btnEnvoyer.disabled = false;
        
        // Fermer le modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('nouveauMessageModal'));
        if (modal) modal.hide();
        
        // Message de succ√®s
        alert('‚úÖ Message envoy√© avec succ√®s √† ' + getDestinataireLabel(destinataire) + '!');
        
        // Vider le formulaire
        form.reset();
    }, 1500);
}

function getDestinataireLabel(value) {
    const labels = {
        'assureur': 'l\\'Assureur',
        'membre': 'le Membre', 
        'agent': 'l\\'Agent',
        'medecin': 'le M√©decin',
        'pharmacien': 'le Pharmacien',
        'administration': 'l\\'Administration'
    };
    return labels[value] || value;
}

// Initialisation am√©lior√©e
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ NOUVEAU MODAL INITIALIS√â - Tous les destinataires disponibles');
    
    // S'assurer que tous les boutons "Nouveau message" ouvrent le modal
    document.querySelectorAll('button, a').forEach(element => {
        const text = element.textContent.toLowerCase();
        if ((text.includes('nouveau') && text.includes('message')) || 
            text.includes('nouveau message') ||
            text.includes('nouveaumessage')) {
            console.log('üéØ Bouton trouv√©:', element);
            
            // Ajouter les attributs Bootstrap
            element.setAttribute('data-bs-toggle', 'modal');
            element.setAttribute('data-bs-target', '#nouveauMessageModal');
            
            // S'assurer que c'est un bouton de type button
            if (element.tagName === 'BUTTON') {
                element.setAttribute('type', 'button');
            }
            
            // Ajouter un style si n√©cessaire
            if (!element.classList.contains('btn')) {
                element.classList.add('btn', 'btn-primary');
            }
            
            console.log('üîß Bouton configur√©:', element);
        }
    });
    
    // √âcouteurs d'√©v√©nements pour le modal
    const modalElement = document.getElementById('nouveauMessageModal');
    if (modalElement) {
        modalElement.addEventListener('show.bs.modal', function() {
            console.log('üéØ Modal nouveau message ouvert!');
            // R√©initialiser le formulaire √† l'ouverture
            document.getElementById('messageForm').reset();
        });
        
        modalElement.addEventListener('hidden.bs.modal', function() {
            console.log('üîí Modal nouveau message ferm√©!');
        });
    }
});
</script>
'''

    # 2. Remplacer le fichier modal existant
    modal_file = BASE_DIR / 'templates' / 'communication' / 'partials' / '_nouveau_message_modal.html'
    
    # S'assurer que le dossier existe
    modal_file.parent.mkdir(parents=True, exist_ok=True)
    
    with open(modal_file, 'w', encoding='utf-8') as f:
        f.write(new_modal_content)
    
    print("‚úÖ MODAL CR√â√â AVEC TOUS LES DESTINATAIRES !")
    print("üìã Destinataires disponibles: Assureur, Membre, Agent, M√©decin, Pharmacien, Administration")
    
    # 3. Maintenant, corriger les boutons dans les templates principaux
    fix_buttons_in_templates()
    
    print("üéØ CORRECTION TERMIN√âE !")

def fix_buttons_in_templates():
    """Corrige les boutons dans les templates principaux"""
    
    # Templates √† v√©rifier/corriger
    templates_to_check = [
        BASE_DIR / 'templates' / 'communication' / 'messagerie.html',
        BASE_DIR / 'templates' / 'communication' / 'boite_reception.html',
        BASE_DIR / 'templates' / 'communication' / 'messages_envoyes.html',
        BASE_DIR / 'templates' / 'dashboard' / 'index.html',
    ]
    
    for template_file in templates_to_check:
        if template_file.exists():
            print(f"üîç V√©rification de {template_file}")
            
            with open(template_file, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # Rechercher les boutons nouveau message
            if 'nouveau message' in content.lower() or 'nouveaumessage' in content.lower():
                print(f"   üìù Bouton trouv√© dans {template_file.name}")
                
                # Remplacer les boutons probl√©matiques
                new_content = fix_button_in_content(content)
                
                if new_content != content:
                    with open(template_file, 'w', encoding='utf-8') as f:
                        f.write(new_content)
                    print(f"   ‚úÖ Bouton corrig√© dans {template_file.name}")
                else:
                    print(f"   ‚ÑπÔ∏è  Bouton d√©j√† correct dans {template_file.name}")

def fix_button_in_content(content):
    """Corrige le bouton dans le contenu du template"""
    
    # Pattern 1: Bouton avec mauvais data-target
    content = content.replace('data-target="#nouveauMessageModal"', 'data-bs-toggle="modal" data-bs-target="#nouveauMessageModal"')
    content = content.replace('data-toggle="modal"', 'data-bs-toggle="modal"')
    
    # Pattern 2: Bouton sans attributs Bootstrap
    import re
    
    # Chercher tous les boutons ou liens contenant "Nouveau message"
    patterns = [
        r'<button[^>]*>(?:(?!</button>).)*?[Nn]ouveau\s*[Mm]essage(?:(?!</button>).)*?</button>',
        r'<a[^>]*>(?:(?!</a>).)*?[Nn]ouveau\s*[Mm]essage(?:(?!</a>).)*?</a>'
    ]
    
    for pattern in patterns:
        matches = re.finditer(pattern, content, re.DOTALL)
        for match in matches:
            original_button = match.group(0)
            
            # V√©rifier si le bouton a d√©j√† les bons attributs
            if 'data-bs-toggle="modal"' in original_button and 'data-bs-target="#nouveauMessageModal"' in original_button:
                continue
            
            print(f"   üîß Correction du bouton: {original_button[:50]}...")
            
            # Corriger le bouton
            if 'button' in original_button:
                # C'est un bouton
                if 'type=' not in original_button:
                    corrected_button = original_button.replace('<button', '<button type="button"')
                else:
                    # Remplacer type="submit" par type="button"
                    corrected_button = re.sub(r'type="submit"', 'type="button"', original_button)
                    corrected_button = re.sub(r"type='submit'", "type='button'", corrected_button)
                
                # Ajouter les attributs Bootstrap
                if 'data-bs-toggle="modal"' not in corrected_button:
                    corrected_button = corrected_button.replace('<button', '<button data-bs-toggle="modal"')
                if 'data-bs-target="#nouveauMessageModal"' not in corrected_button:
                    corrected_button = corrected_button.replace('<button', '<button data-bs-target="#nouveauMessageModal"')
            
            else:
                # C'est un lien
                corrected_button = original_button
                if 'data-bs-toggle="modal"' not in corrected_button:
                    corrected_button = corrected_button.replace('<a', '<a data-bs-toggle="modal"')
                if 'data-bs-target="#nouveauMessageModal"' not in corrected_button:
                    corrected_button = corrected_button.replace('<a', '<a data-bs-target="#nouveauMessageModal"')
                # Pour les liens, ajouter href="#" pour √©viter la navigation
                if 'href=' not in corrected_button:
                    corrected_button = corrected_button.replace('<a', '<a href="#"')
            
            # S'assurer d'avoir les classes Bootstrap si n√©cessaire
            if 'btn btn-primary' not in corrected_button and 'class="' in corrected_button:
                corrected_button = corrected_button.replace('class="', 'class="btn btn-primary ')
            elif 'btn btn-primary' not in corrected_button:
                # Ajouter la classe si elle n'existe pas
                corrected_button = corrected_button.replace('<', ' class="btn btn-primary"<', 1)
            
            # Remplacer dans le contenu
            content = content.replace(original_button, corrected_button)
    
    return content

def verify_modal_inclusion():
    """V√©rifie que le modal est inclus dans les templates principaux"""
    
    main_templates = [
        BASE_DIR / 'templates' / 'communication' / 'messagerie.html',
        BASE_DIR / 'templates' / 'communication' / 'boite_reception.html',
        BASE_DIR / 'templates' / 'communication' / 'messages_envoyes.html',
    ]
    
    for template in main_templates:
        if template.exists():
            with open(template, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # V√©rifier si le modal est inclus
            if 'nouveauMessageModal' not in content and '_nouveau_message_modal.html' not in content:
                print(f"‚ö†Ô∏è  Le modal n'est pas inclus dans {template.name}")
                print("   Ajout de l'inclusion...")
                
                # Ajouter l'inclusion du modal avant la fermeture du body
                inclusion_code = '\n{# Inclusion du modal nouveau message #}\n{% include "communication/partials/_nouveau_message_modal.html" %}\n'
                
                if '</body>' in content:
                    new_content = content.replace('</body>', inclusion_code + '\n</body>')
                else:
                    new_content = content + inclusion_code
                
                with open(template, 'w', encoding='utf-8') as f:
                    f.write(new_content)
                
                print(f"   ‚úÖ Inclusion ajout√©e dans {template.name}")

if __name__ == "__main__":
    fix_nouveau_message_button()
    verify_modal_inclusion()
    
    print("\nüéØ CORRECTION TERMIN√âE AVEC SUCC√àS!")
    print("üìã DESTINATAIRES AJOUT√âS:")
    print("   ‚Ä¢ ‚úÖ Assureur")
    print("   ‚Ä¢ ‚úÖ Membre") 
    print("   ‚Ä¢ ‚úÖ Agent")
    print("   ‚Ä¢ ‚úÖ M√©decin")
    print("   ‚Ä¢ ‚úÖ Pharmacien")
    print("   ‚Ä¢ ‚úÖ Administration")
    print("\nüîß POUR TESTER:")
    print("1. Rechargez la page messagerie")
    print("2. Cliquez sur 'Nouveau Message'")
    print("3. V√©rifiez que tous les destinataires sont dans la liste")
    print("4. Testez l'envoi d'un message")