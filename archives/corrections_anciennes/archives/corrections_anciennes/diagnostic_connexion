# diagnostic_connexion.py
import os
import sys
import django
from django.test import Client
from django.contrib.auth import get_user_model
from django.contrib.sessions.models import Session
from django.core.management import call_command
from django.conf import settings

# Configuration de l'environnement Django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'mutuelle_core.settings')
django.setup()

User = get_user_model()

class DiagnosticConnexion:
    """
    Script de diagnostic complet du processus de connexion
    pour tous les acteurs du syst√®me (m√©decins, pharmaciens, agents, etc.)
    """
    
    def __init__(self):
        self.client = Client()
        self.results = {
            'tests_passes': 0,
            'tests_echecs': 0,
            'problemes': []
        }
    
    def print_header(self, title):
        """Affiche un en-t√™te de section"""
        print(f"\n{'='*60}")
        print(f"üîç {title}")
        print(f"{'='*60}")
    
    def print_success(self, message):
        """Affiche un message de succ√®s"""
        print(f"‚úÖ {message}")
        self.results['tests_passes'] += 1
    
    def print_error(self, message):
        """Affiche un message d'erreur"""
        print(f"‚ùå {message}")
        self.results['tests_echecs'] += 1
        self.results['problemes'].append(message)
    
    def print_warning(self, message):
        """Affiche un message d'avertissement"""
        print(f"‚ö†Ô∏è {message}")
    
    def print_info(self, message):
        """Affiche un message d'information"""
        print(f"‚ÑπÔ∏è {message}")
    
    def test_configuration_base(self):
        """Test la configuration de base de Django"""
        self.print_header("CONFIGURATION DE BASE DJANGO")
        
        # V√©rification des settings critiques
        critical_settings = [
            'SECRET_KEY',
            'DEBUG',
            'ALLOWED_HOSTS',
            'DATABASES',
            'INSTALLED_APPS',
            'MIDDLEWARE',
            'AUTH_PASSWORD_VALIDATORS'
        ]
        
        for setting in critical_settings:
            try:
                value = getattr(settings, setting, None)
                if value:
                    self.print_success(f"Setting {setting}: OK")
                else:
                    self.print_error(f"Setting {setting}: VIDE ou MANQUANT")
            except Exception as e:
                self.print_error(f"Setting {setting}: ERREUR - {e}")
    
    def test_configuration_auth(self):
        """Test la configuration d'authentification"""
        self.print_header("CONFIGURATION AUTHENTIFICATION")
        
        auth_settings = [
            ('LOGIN_URL', '/accounts/login/'),
            ('LOGIN_REDIRECT_URL', '/redirect-after-login/'),
            ('LOGOUT_REDIRECT_URL', '/'),
        ]
        
        for setting, expected in auth_settings:
            try:
                value = getattr(settings, setting, None)
                if value == expected:
                    self.print_success(f"{setting}: {value} (OK)")
                else:
                    self.print_warning(f"{setting}: {value} (Attendu: {expected})")
            except Exception as e:
                self.print_error(f"{setting}: ERREUR - {e}")
    
    def test_configuration_sessions(self):
        """Test la configuration des sessions"""
        self.print_header("CONFIGURATION SESSIONS & COOKIES")
        
        session_settings = [
            ('SESSION_ENGINE', 'django.contrib.sessions.backends.db'),
            ('SESSION_COOKIE_NAME', 'mutuelle_sessionid'),
            ('SESSION_COOKIE_AGE', 1209600),
            ('SESSION_EXPIRE_AT_BROWSER_CLOSE', False),
            ('SESSION_SAVE_EVERY_REQUEST', True),
            ('SESSION_COOKIE_SECURE', False),  # Dev uniquement
            ('SESSION_COOKIE_HTTPONLY', True),
            ('SESSION_COOKIE_SAMESITE', 'Lax'),
        ]
        
        for setting, expected in session_settings:
            try:
                value = getattr(settings, setting, None)
                if value == expected:
                    self.print_success(f"{setting}: {value} (OK)")
                else:
                    self.print_warning(f"{setting}: {value} (Attendu: {expected})")
            except Exception as e:
                self.print_error(f"{setting}: ERREUR - {e}")
    
    def test_modeles_utilisateurs(self):
        """Test la pr√©sence des mod√®les utilisateurs"""
        self.print_header("MOD√àLES UTILISATEURS")
        
        try:
            # V√©rifie que le mod√®le User standard fonctionne
            user_count = User.objects.count()
            self.print_info(f"Nombre total d'utilisateurs: {user_count}")
            
            # V√©rifie les mod√®les sp√©cifiques aux acteurs
            modeles_acteurs = [
                'Medecin',
                'Pharmacien', 
                'Agent',
                'Membre'
            ]
            
            for modele in modeles_acteurs:
                try:
                    # Essaye d'importer le mod√®le
                    from django.apps import apps
                    model_class = apps.get_model(modele.lower(), modele)
                    count = model_class.objects.count()
                    self.print_success(f"Mod√®le {modele}: {count} instances")
                except LookupError:
                    self.print_error(f"Mod√®le {modele}: NON TROUV√â")
                except Exception as e:
                    self.print_warning(f"Mod√®le {modele}: ERREUR - {e}")
                    
        except Exception as e:
            self.print_error(f"Erreur g√©n√©rale mod√®les: {e}")
    
    def test_urls_authentification(self):
        """Test les URLs d'authentification"""
        self.print_header("URLS AUTHENTIFICATION")
        
        urls_a_tester = [
            '/accounts/login/',
            '/accounts/logout/',
            '/redirect-after-login/',
            '/medecin/login/',
            '/pharmacien/login/',
            '/agent/login/',
        ]
        
        for url in urls_a_tester:
            try:
                response = self.client.get(url)
                status_info = f"Status: {response.status_code}"
                
                if response.status_code in [200, 302]:
                    self.print_success(f"URL {url}: {status_info}")
                else:
                    self.print_warning(f"URL {url}: {status_info}")
                    
            except Exception as e:
                self.print_error(f"URL {url}: ERREUR - {e}")
    
    def test_processus_connexion_medecin(self):
        """Test sp√©cifique au processus de connexion m√©decin"""
        self.print_header("PROCESSUS CONNEXION M√âDECIN")
        
        try:
            # Test de la redirection initiale
            response = self.client.get('/', follow=False)
            self.print_info(f"Redirection /: Status {response.status_code}")
            
            if response.status_code == 302:
                self.print_info(f"Redirection vers: {response.url}")
            
            # Test avec follow
            response = self.client.get('/', follow=True)
            self.print_info(f"Cha√Æne de redirection: {len(response.redirect_chain)} √©tapes")
            
            for i, (url, status) in enumerate(response.redirect_chain):
                self.print_info(f"Redirection {i+1}: {status} -> {url}")
            
            # V√©rification finale
            if response.status_code == 200:
                self.print_success("Redirection termin√©e avec succ√®s")
            else:
                self.print_error(f"Redirection √©chou√©e: Status {response.status_code}")
                
        except Exception as e:
            self.print_error(f"Erreur processus m√©decin: {e}")
    
    def test_creation_session(self):
        """Test la cr√©ation et gestion des sessions"""
        self.print_header("TEST DES SESSIONS")
        
        try:
            # Test cr√©ation de session
            session = self.client.session
            session['test_key'] = 'test_value'
            session.save()
            
            # V√©rification
            if 'test_key' in self.client.session:
                self.print_success("Session: Cr√©ation et sauvegarde OK")
            else:
                self.print_error("Session: √âchec cr√©ation/sauvegarde")
            
            # Test compteur sessions en base
            session_count = Session.objects.count()
            self.print_info(f"Sessions en base: {session_count}")
            
        except Exception as e:
            self.print_error(f"Erreur sessions: {e}")
    
    def test_middleware_connexion(self):
        """Test le middleware de tracking des connexions"""
        self.print_header("MIDDLEWARE TRACKING")
        
        try:
            # Simule une requ√™te avec le middleware
            response = self.client.get('/')
            
            # V√©rifie si le middleware a √©t√© ex√©cut√©
            # (cette v√©rification d√©pend de l'impl√©mentation r√©elle)
            self.print_info("Middleware TrackingConnexionsMiddleware: Charg√©")
            
            # Test avec un utilisateur connect√©
            from django.contrib.auth.models import User
            test_user = User.objects.create_user(
                username='test_middleware',
                password='testpass123'
            )
            
            self.client.login(username='test_middleware', password='testpass123')
            response = self.client.get('/', follow=True)
            
            self.print_success("Middleware: Test avec utilisateur connect√© OK")
            
            # Nettoyage
            test_user.delete()
            
        except Exception as e:
            self.print_error(f"Erreur middleware: {e}")
    
    def test_performances_redirections(self):
        """Test les performances des redirections"""
        self.print_header("TESTS DE PERFORMANCE")
        
        import time
        
        urls_a_tester = [
            '/',
            '/medecin/dashboard/',
            '/redirect-after-login/'
        ]
        
        for url in urls_a_tester:
            try:
                start_time = time.time()
                response = self.client.get(url, follow=True)
                end_time = time.time()
                
                duree = (end_time - start_time) * 1000  # en ms
                status = "‚úÖ OK" if response.status_code == 200 else "‚ö†Ô∏è ATTENTION"
                
                self.print_info(f"Performance {url}: {duree:.2f}ms - {status}")
                
                if duree > 1000:  # Plus d'1 seconde
                    self.print_warning(f"Temps de r√©ponse √©lev√© pour {url}")
                    
            except Exception as e:
                self.print_error(f"Erreur performance {url}: {e}")
    
    def test_cas_erreur_connexion(self):
        """Test les cas d'erreur de connexion"""
        self.print_header("CAS D'ERREUR CONNEXION")
        
        # Test connexion avec mauvais identifiants
        response = self.client.post('/accounts/login/', {
            'username': 'utilisateur_inexistant',
            'password': 'mauvais_mot_de_passe'
        })
        
        if response.status_code in [200, 403]:
            self.print_success("Gestion erreur identifiants: OK")
        else:
            self.print_warning("Gestion erreur identifiants: Comportement inattendu")
    
    def generer_rapport(self):
        """G√©n√®re un rapport final"""
        self.print_header("RAPPORT FINAL DIAGNOSTIC")
        
        total_tests = self.results['tests_passes'] + self.results['tests_echecs']
        
        print(f"üìä R√âSULTATS GLOBAUX:")
        print(f"   Tests pass√©s: {self.results['tests_passes']}/{total_tests}")
        print(f"   Tests √©chou√©s: {self.results['tests_echecs']}/{total_tests}")
        
        if self.results['problemes']:
            print(f"\nüö® PROBL√àMES IDENTIFI√âS:")
            for i, probleme in enumerate(self.results['problemes'], 1):
                print(f"   {i}. {probleme}")
        
        print(f"\nüí° RECOMMANDATIONS:")
        
        if self.results['tests_echecs'] == 0:
            print("   ‚úÖ Tous les tests sont pass√©s avec succ√®s!")
        else:
            if any("SESSION" in probleme for probleme in self.results['problemes']):
                print("   üîß V√©rifiez la configuration des sessions et cookies")
            
            if any("URL" in probleme for probleme in self.results['problemes']):
                print("   üîß V√©rifiez la configuration des URLs et vues")
            
            if any("Mod√®le" in probleme for probleme in self.results['problemes']):
                print("   üîß V√©rifiez les mod√®les et les relations utilisateurs")
            
            print("   üìù Consultez les logs d√©taill√©s ci-dessus pour les corrections")
    
    def executer_diagnostic_complet(self):
        """Ex√©cute tous les tests de diagnostic"""
        print("üöÄ LANCEMENT DU DIAGNOSTIC COMPLET CONNEXION")
        print("‚è∞ Cette op√©ration peut prendre quelques secondes...")
        
        try:
            self.test_configuration_base()
            self.test_configuration_auth()
            self.test_configuration_sessions()
            self.test_modeles_utilisateurs()
            self.test_urls_authentification()
            self.test_processus_connexion_medecin()
            self.test_creation_session()
            self.test_middleware_connexion()
            self.test_performances_redirections()
            self.test_cas_erreur_connexion()
            
            self.generer_rapport()
            
        except Exception as e:
            self.print_error(f"Erreur lors du diagnostic: {e}")
            import traceback
            traceback.print_exc()

# Script d'ex√©cution direct
if __name__ == "__main__":
    diagnostic = DiagnosticConnexion()
    diagnostic.executer_diagnostic_complet()