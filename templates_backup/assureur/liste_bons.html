{% extends "assureur/base_assureur.html" %}
{% load static %}

{% block title %}Liste des Bons de Soin - Assureur{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête avec actions -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-file-medical me-2 text-success"></i>Liste des Bons de Soin
        </h1>
        <div class="btn-group">
            <a href="{% url 'assureur:export_bons_pdf' %}?format=csv" class="btn btn-outline-success">
                <i class="fas fa-download me-1"></i>Export CSV
            </a>
            <a href="{% url 'assureur:export_bons_pdf' %}?format=pdf" class="btn btn-outline-danger">
                <i class="fas fa-file-pdf me-1"></i>Export PDF
            </a>
            <a href="{% url 'assureur:recherche_membre' %}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>Nouveau Bon
            </a>
        </div>
    </div>

    <!-- Cartes de statistiques -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-start border-primary border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="small fw-bold text-primary mb-1">Total Bons</div>
                            <div class="h5 mb-0">{{ stats.total_bons }}</div>
                        </div>
                        <div class="ms-2">
                            <i class="fas fa-file-medical fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-start border-success border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="small fw-bold text-success mb-1">Bons Utilisés</div>
                            <div class="h5 mb-0">{{ stats.bons_utilises }}</div>
                        </div>
                        <div class="ms-2">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-start border-warning border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="small fw-bold text-warning mb-1">Bons Émis</div>
                            <div class="h5 mb-0">{{ stats.bons_emis }}</div>
                        </div>
                        <div class="ms-2">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-start border-danger border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="small fw-bold text-danger mb-1">Bons Annulés</div>
                            <div class="h5 mb-0">{{ stats.bons_annules }}</div>
                        </div>
                        <div class="ms-2">
                            <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="card-title mb-0">
                <i class="fas fa-filter me-2"></i>Filtres de recherche
            </h6>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label for="statut" class="form-label">Statut</label>
                    <select class="form-select" id="statut" name="statut">
                        <option value="">Tous les statuts</option>
                        {% for value, label in statuts_bons %}
                        <option value="{{ value }}" {% if request.GET.statut == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="type_soin" class="form-label">Type de soin</label>
                    <select class="form-select" id="type_soin" name="type_soin">
                        <option value="">Tous les types</option>
                        {% for value, label in types_soins %}
                        <option value="{{ value }}" {% if request.GET.type_soin == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="priorite" class="form-label">Priorité</label>
                    <select class="form-select" id="priorite" name="priorite">
                        <option value="">Toutes les priorités</option>
                        {% for value, label in priorities %}
                        <option value="{{ value }}" {% if request.GET.priorite == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="date_debut" class="form-label">Date début</label>
                    <input type="date" class="form-control" id="date_debut" name="date_debut" 
                           value="{{ request.GET.date_debut }}">
                </div>

                <div class="col-md-3">
                    <label for="date_fin" class="form-label">Date fin</label>
                    <input type="date" class="form-control" id="date_fin" name="date_fin" 
                           value="{{ request.GET.date_fin }}">
                </div>

                <div class="col-md-3">
                    <label for="search" class="form-label">Recherche</label>
                    <input type="text" class="form-control" id="search" name="search" 
                           placeholder="Numéro bon ou membre..." value="{{ request.GET.search }}">
                </div>
                
                <div class="col-md-6 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-search me-1"></i>Filtrer
                    </button>
                    <a href="{% url 'assureur:liste_bons' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i>Effacer
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Statistiques des filtres -->
    {% if request.GET %}
    <div class="alert alert-info d-flex justify-content-between align-items-center">
        <div>
            <i class="fas fa-info-circle me-2"></i>
            Filtres actifs : 
            {% if request.GET.statut %}Statut: <strong>{{ request.GET.statut }}</strong>{% endif %}
            {% if request.GET.type_soin %}Type: <strong>{{ request.GET.type_soin }}</strong>{% endif %}
            {% if request.GET.priorite %}Priorité: <strong>{{ request.GET.priorite }}</strong>{% endif %}
            {% if request.GET.search %}Recherche: <strong>{{ request.GET.search }}</strong>{% endif %}
        </div>
        <span class="badge bg-primary">{{ bons.paginator.count }} résultat(s)</span>
    </div>
    {% endif %}

    <!-- Tableau des bons -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="card-title mb-0">
                <i class="fas fa-list me-2"></i>Bons de soin ({{ bons.paginator.count }})
            </h6>
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-secondary" onclick="actualiserListe()" title="Actualiser">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="exporterTableau()" title="Exporter tableau">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </div>
        
        <div class="card-body">
            {% if bons %}
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="tableauBons">
                    <thead class="table-light">
                        <tr>
                            <th>N° Bon</th>
                            <th>Membre</th>
                            <th>Type de soin</th>
                            <th>Date émission</th>
                            <th>Date utilisation</th>
                            <th>Statut</th>
                            <th>Priorité</th>
                            <th>Montant</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bon in bons %}
                        <tr>
                            <td class="fw-bold">
                                <i class="fas fa-file-medical text-success me-1"></i>
                                {{ bon.numero_bon|default:"N/A" }}
                            </td>
                            <td>
                                {% if bon.membre %}
                                <a href="{% url 'assureur:detail_membre' bon.membre.id %}" 
                                   class="text-decoration-none">
                                    {{ bon.membre.nom_complet|default:bon.membre.numero_unique }}
                                </a>
                                <br>
                                <small class="text-muted">{{ bon.membre.numero_unique }}</small>
                                {% else %}
                                <span class="text-muted">Membre inconnu</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-info">{{ bon.get_type_soin_display|default:"Non spécifié" }}</span>
                            </td>
                            <td>
                                {{ bon.date_emission|date:"d/m/Y"|default:"-" }}
                                {% if bon.heure_emission %}
                                <br>
                                <small class="text-muted">{{ bon.heure_emission }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if bon.date_utilisation %}
                                {{ bon.date_utilisation|date:"d/m/Y" }}
                                {% if bon.heure_utilisation %}
                                <br>
                                <small class="text-muted">{{ bon.heure_utilisation }}</small>
                                {% endif %}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if bon.status == 'EMIS' %}
                                <span class="badge bg-warning">{{ bon.get_statut_display }}</span>
                                {% elif bon.status == 'UTILISE' %}
                                <span class="badge bg-success">{{ bon.get_statut_display }}</span>
                                {% elif bon.status == 'ANNULE' %}
                                <span class="badge bg-danger">{{ bon.get_statut_display }}</span>
                                {% elif bon.status == 'REMBOURSE' %}
                                <span class="badge bg-info">{{ bon.get_statut_display }}</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ bon.get_statut_display }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if bon.priorite == 'URGENTE' %}
                                <span class="badge bg-danger">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    {{ bon.get_priorite_display }}
                                </span>
                                {% elif bon.priorite == 'PRIORITAIRE' %}
                                <span class="badge bg-warning">
                                    <i class="fas fa-exclamation-circle me-1"></i>
                                    {{ bon.get_priorite_display }}
                                </span>
                                {% else %}
                                <span class="badge bg-secondary">{{ bon.get_priorite_display }}</span>
                                {% endif %}
                            </td>
                            <td class="fw-bold text-success">
                                {{ bon.montant|default:"0.00" }} €
                                {% if bon.montant_reel and bon.montant_reel != bon.montant %}
                                <br>
                                <small class="text-primary">Réel: {{ bon.montant_reel }} €</small>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary view-bon" 
                                            data-bon-id="{{ bon.id }}"
                                            title="Voir détails">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    {% if bon.status == 'EMIS' %}
                                    <button class="btn btn-outline-warning edit-bon" 
                                            data-bon-id="{{ bon.id }}"
                                            title="Modifier">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger cancel-bon" 
                                            data-bon-id="{{ bon.id }}"
                                            title="Annuler">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                    {% endif %}
                                    {% if bon.status == 'UTILISE' %}
                                    <button class="btn btn-outline-info download-bon" 
                                            data-bon-id="{{ bon.id }}"
                                            title="Télécharger">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if bons.has_other_pages %}
            <nav aria-label="Pagination">
                <ul class="pagination justify-content-center mt-4">
                    {% if bons.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ bons.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for num in bons.paginator.page_range %}
                        {% if bons.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                        {% elif num > bons.number|add:'-3' and num < bons.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                {{ num }}
                            </a>
                        </li>
                        {% endif %}
                    {% endfor %}

                    {% if bons.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ bons.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-angle-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ bons.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
                <div class="text-center text-muted small">
                    Page {{ bons.number }} sur {{ bons.paginator.num_pages }}
                </div>
            </nav>
            {% endif %}

            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-file-medical fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Aucun bon de soin trouvé</h5>
                <p class="text-muted">
                    {% if request.GET %}
                    Aucun résultat ne correspond à vos critères de recherche.
                    {% else %}
                    Aucun bon de soin n'a été créé pour le moment.
                    {% endif %}
                </p>
                <a href="{% url 'assureur:recherche_membre' %}" class="btn btn-primary mt-2">
                    <i class="fas fa-plus me-1"></i>Créer un premier bon
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal pour détails bon -->
<div class="modal fade" id="modalDetailsBon" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-file-medical me-2"></i>Détails du bon de soin
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalDetailsContent">
                <!-- Contenu chargé via AJAX -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" onclick="imprimerDetails()">
                    <i class="fas fa-print me-1"></i>Imprimer
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Gestion des événements avec data attributes
document.addEventListener('DOMContentLoaded', function() {
    // Voir détails
    document.querySelectorAll('.view-bon').forEach(button => {
        button.addEventListener('click', function() {
            const bonId = this.getAttribute('data-bon-id');
            afficherDetailsBon(bonId);
        });
    });

    // Modifier
    document.querySelectorAll('.edit-bon').forEach(button => {
        button.addEventListener('click', function() {
            const bonId = this.getAttribute('data-bon-id');
            modifierBon(bonId);
        });
    });

    // Annuler
    document.querySelectorAll('.cancel-bon').forEach(button => {
        button.addEventListener('click', function() {
            const bonId = this.getAttribute('data-bon-id');
            annulerBon(bonId);
        });
    });

    // Télécharger
    document.querySelectorAll('.download-bon').forEach(button => {
        button.addEventListener('click', function() {
            const bonId = this.getAttribute('data-bon-id');
            telechargerBon(bonId);
        });
    });
});

function actualiserListe() {
    location.reload();
}

function afficherDetailsBon(bonId) {
    $('#modalDetailsContent').html(`
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-2">Chargement des détails du bon...</p>
        </div>
    `);
    
    $('#modalDetailsBon').modal('show');
    
    // Simulation d'appel AJAX - À remplacer par un vrai appel
    setTimeout(() => {
        $('#modalDetailsContent').html(`
            <div class="row">
                <div class="col-md-6">
                    <h6>Informations du bon</h6>
                    <table class="table table-sm">
                        <tr><td><strong>N° Bon:</strong></td><td>BS-${bonId}</td></tr>
                        <tr><td><strong>Statut:</strong></td><td><span class="badge bg-warning">Émis</span></td></tr>
                        <tr><td><strong>Type de soin:</strong></td><td>Consultation générale</td></tr>
                        <tr><td><strong>Priorité:</strong></td><td><span class="badge bg-secondary">Normale</span></td></tr>
                        <tr><td><strong>Montant:</strong></td><td>50.00 €</td></tr>
                        <tr><td><strong>Date émission:</strong></td><td>15/12/2023</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Informations du membre</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Nom:</strong></td><td>Dupont Jean</td></tr>
                        <tr><td><strong>N° Membre:</strong></td><td>MEM-001</td></tr>
                        <tr><td><strong>Téléphone:</strong></td><td>+225 07 12 34 56 78</td></tr>
                        <tr><td><strong>Email:</strong></td><td>jean.dupont@example.com</td></tr>
                    </table>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Description des soins</h6>
                    <div class="card">
                        <div class="card-body">
                            <p class="mb-0">Consultation médicale générale avec examen de routine.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Historique</h6>
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <strong>Bon émis</strong>
                                <small class="text-muted"> - 15/12/2023</small>
                                <p>Bon créé par l'agent Koffi</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `);
    }, 1000);
}

function modifierBon(bonId) {
    if (confirm('Voulez-vous modifier ce bon de soin ?')) {
        // Redirection vers la page de modification
        window.location.href = '/assureur/bons/' + bonId + '/modifier/';
    }
}

function annulerBon(bonId) {
    if (confirm('Êtes-vous sûr de vouloir annuler ce bon de soin ? Cette action est irréversible.')) {
        // Appel AJAX pour annuler le bon
        fetch('/assureur/bons/' + bonId + '/annuler/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Bon annulé avec succès', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert('Erreur: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Erreur lors de l\'annulation du bon', 'error');
        });
    }
}

function telechargerBon(bonId) {
    showAlert('Téléchargement du bon PDF...', 'info');
    // Implémentation du téléchargement PDF
    window.open('/assureur/bons/' + bonId + '/pdf/', '_blank');
}

function exporterTableau() {
    // Implémentation de l'export du tableau
    showAlert('Export du tableau en cours...', 'info');
    // Ici vous pouvez ajouter la logique d'export CSV/Excel
}

function imprimerDetails() {
    window.print();
}

function showAlert(message, type = 'info') {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[type] || 'alert-info';

    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            <strong>${message}</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('body').append(alertHtml);
    
    setTimeout(() => {
        $('.alert').alert('close');
    }, 3000);
}

// Actualisation automatique toutes les 5 minutes
setTimeout(() => {
    actualiserListe();
}, 300000);
</script>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -30px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #6c757d;
}

.timeline-content {
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    border-left: 3px solid #007bff;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.1);
}

.badge {
    font-size: 0.75em;
}

.card {
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    border: 1px solid #e3e6f0;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

/* Responsive */
@media (max-width: 768px) {
    .container-fluid {
        padding: 0 10px;
    }
    
    .btn-group {
        flex-wrap: wrap;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
}
</style>
{% endblock %}