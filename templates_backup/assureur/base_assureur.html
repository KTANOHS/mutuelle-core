{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Espace Assureur - Mutuelle Core{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/assureur.css' %}">
    
    {% block extra_css %}{% endblock %}
</head>
<body class="d-flex">
    <!-- Sidebar -->
    <nav id="sidebar" class="bg-dark text-white">
        <div class="sidebar-header p-3">
            <h4 class="text-center">
                <i class="fas fa-shield-alt me-2"></i>
                Assureur
            </h4>
        </div>
        
        <ul class="list-unstyled components">
            <li>
                <a href="{% url 'assureur:dashboard' %}" class="sidebar-link">
                    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                </a>
            </li>
            <li>
                <a href="{% url 'assureur:recherche_membre' %}" class="sidebar-link">
                    <i class="fas fa-search me-2"></i>Recherche Membre
                </a>
            </li>
            <li>
                <a href="{% url 'assureur:creer_membre' %}" class="sidebar-link">
                    <i class="fas fa-user-plus me-2"></i>Créer Membre
                </a>
            </li>
            <li>
                <a href="{% url 'assureur:liste_bons' %}" class="sidebar-link">
                    <i class="fas fa-file-medical me-2"></i>Bons de Soin
                </a>
            </li>
            <li>
                <a href="{% url 'assureur:liste_paiements' %}" class="sidebar-link">
                    <i class="fas fa-money-bill-wave me-2"></i>Paiements
                </a>
            </li>
            <li>
                <a href="{% url 'assureur:rapport_statistiques' %}" class="sidebar-link">
                    <i class="fas fa-chart-bar me-2"></i>Rapports
                </a>
            </li>
            
            <!-- AJOUT: Section Communication -->
            <li class="mt-3 border-top pt-2">
                <a href="#communicationSubmenu" data-bs-toggle="collapse" class="sidebar-link dropdown-toggle">
                    <i class="fas fa-comments me-2"></i>Communication
                </a>
                <ul class="collapse list-unstyled" id="communicationSubmenu">
                    <li>
                        <a href="{% url 'assureur:liste_messages' %}" class="sidebar-link ps-4">
                            <i class="fas fa-inbox me-2"></i>Messages
                            {% if messages_non_lus %}
                            <span class="badge bg-danger float-end">{{ messages_non_lus }}</span>
                            {% endif %}
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'assureur:envoyer_message' %}" class="sidebar-link ps-4">
                            <i class="fas fa-paper-plane me-2"></i>Envoyer
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'assureur:liste_notifications' %}" class="sidebar-link ps-4">
                            <i class="fas fa-bell me-2"></i>Notifications
                            {% if notifications_non_lues %}
                            <span class="badge bg-warning float-end">{{ notifications_non_lues }}</span>
                            {% endif %}
                        </a>
                    </li>
                </ul>
            </li>
        </ul>
        
        <div class="sidebar-footer p-3">
            <div class="user-info">
                <small>Connecté en tant que <strong>{{ request.user.username }}</strong></small>
            </div>
            <!-- CORRECTION : Formulaire de déconnexion -->
            <form method="post" action="{% url 'logout' %}" class="w-100">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-light w-100 mt-2">
                    <i class="fas fa-sign-out-alt me-1"></i>Déconnexion
                </button>
            </form>
        </div>
    </nav>

    <!-- Page Content -->
    <div id="content" class="w-100">
        <!-- Top Navbar -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
            <div class="container-fluid">
                <button type="button" id="sidebarCollapse" class="btn btn-outline-secondary">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="navbar-nav ms-auto">
                    <!-- AJOUT: Indicateurs de communication -->
                    <div class="d-flex align-items-center me-3">
                        <!-- Messages non lus -->
                        <a href="{% url 'assureur:liste_messages' %}" class="btn btn-outline-primary btn-sm me-2 position-relative">
                            <i class="fas fa-envelope"></i>
                            {% if messages_non_lus %}
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                {{ messages_non_lus }}
                            </span>
                            {% endif %}
                        </a>
                        
                        <!-- Notifications -->
                        <a href="{% url 'assureur:liste_notifications' %}" class="btn btn-outline-warning btn-sm me-2 position-relative">
                            <i class="fas fa-bell"></i>
                            {% if notifications_non_lues %}
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning">
                                {{ notifications_non_lues }}
                            </span>
                            {% endif %}
                        </a>
                        
                        <!-- Envoyer message rapide -->
                        <a href="{% url 'assureur:envoyer_message' %}" class="btn btn-outline-success btn-sm me-3">
                            <i class="fas fa-paper-plane"></i>
                        </a>
                    </div>
                    
                    <span class="navbar-text me-3">
                        <i class="fas fa-calendar-day me-1"></i>
                        {{ date_aujourdhui|default:"Aujourd'hui" }}
                    </span>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" 
                                data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>{{ request.user.get_full_name|default:request.user.username }}
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="#">
                                    <i class="fas fa-cog me-2"></i>Paramètres
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'assureur:liste_messages' %}">
                                    <i class="fas fa-envelope me-2"></i>Messages
                                    {% if messages_non_lus %}
                                    <span class="badge bg-danger float-end">{{ messages_non_lus }}</span>
                                    {% endif %}
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'assureur:liste_notifications' %}">
                                    <i class="fas fa-bell me-2"></i>Notifications
                                    {% if notifications_non_lues %}
                                    <span class="badge bg-warning float-end">{{ notifications_non_lues }}</span>
                                    {% endif %}
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <!-- CORRECTION : Formulaire de déconnexion correct -->
                            <li>
                                <form method="post" action="{% url 'logout' %}" class="d-inline w-100">
                                    {% csrf_token %}
                                    <button type="submit" class="dropdown-item border-0 bg-transparent w-100 text-start">
                                        <i class="fas fa-sign-out-alt me-2"></i>Déconnexion
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container-fluid py-4">
            <!-- Messages -->
            {% if messages %}
            <div class="messages">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    <i class="fas 
                        {% if message.tags == 'success' %}fa-check-circle
                        {% elif message.tags == 'error' %}fa-exclamation-circle
                        {% elif message.tags == 'warning' %}fa-exclamation-triangle
                        {% else %}fa-info-circle{% endif %} 
                        me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- AJOUT: Alertes de communication rapides -->
            {% if messages_non_lus or notifications_non_lues %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-info d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Communication :</strong>
                            {% if messages_non_lus %}
                            <span class="me-3">{{ messages_non_lus }} message(s) non lu(s)</span>
                            {% endif %}
                            {% if notifications_non_lues %}
                            <span>{{ notifications_non_lues }} notification(s) non lue(s)</span>
                            {% endif %}
                        </div>
                        <div>
                            <a href="{% url 'assureur:liste_messages' %}" class="btn btn-sm btn-primary me-2">
                                <i class="fas fa-inbox me-1"></i>Voir messages
                            </a>
                            <a href="{% url 'assureur:liste_notifications' %}" class="btn btn-sm btn-warning">
                                <i class="fas fa-bell me-1"></i>Voir notifications
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Page Content -->
            {% block content %}
            {% endblock %}
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Sidebar Toggle Script -->
    <script>
    $(document).ready(function () {
        $('#sidebarCollapse').on('click', function () {
            $('#sidebar').toggleClass('active');
            $('#content').toggleClass('active');
        });
        
        // Gestion automatique de la date d'aujourd'hui
        const today = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const dateString = today.toLocaleDateString('fr-FR', options);
        
        // Mettre à jour l'affichage de la date si vide
        $('.navbar-text').each(function() {
            if ($(this).text().trim() === "Aujourd'hui") {
                $(this).html('<i class="fas fa-calendar-day me-1"></i>' + dateString);
            }
        });

        // Auto-refresh des indicateurs de communication toutes les 30 secondes
        function refreshCommunicationIndicators() {
            $.ajax({
                url: '{% url "assureur:api_statistiques" %}',
                type: 'GET',
                success: function(data) {
                    // Mettre à jour les badges de messages
                    updateBadge('.fa-envelope', data.messages_non_lus);
                    updateBadge('.fa-bell', data.notifications_non_lues);
                },
                error: function() {
                    console.log('Erreur lors du rafraîchissement des indicateurs');
                }
            });
        }

        function updateBadge(iconSelector, count) {
            const badge = $(iconSelector).closest('.btn').find('.badge');
            if (count > 0) {
                badge.text(count).show();
            } else {
                badge.hide();
            }
        }

        // Rafraîchir toutes les 30 secondes
        setInterval(refreshCommunicationIndicators, 30000);
    });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>