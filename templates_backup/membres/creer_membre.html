{% extends "assureur/base_assureur.html" %}
{% load static %}

{% block title %}Créer un Nouveau Membre{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- En-tête -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-user-plus me-2 text-primary"></i>Créer un Nouveau Membre
                </h1>
                <a href="{% url 'assureur:recherche_membre' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i> Retour à la recherche
                </a>
            </div>

            <!-- Formulaire de création -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-id-card me-2"></i>Informations Personnelles
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="formCreerMembre">
                        {% csrf_token %}
                        
                        <!-- Informations de base -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2">
                                    <i class="fas fa-user me-2"></i>Identité
                                </h6>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="nom" class="form-label">Nom *</label>
                                <input type="text" class="form-control" id="nom" name="nom" 
                                       required placeholder="Dupont">
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="prenom" class="form-label">Prénom *</label>
                                <input type="text" class="form-control" id="prenom" name="prenom" 
                                       required placeholder="Jean">
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="date_naissance" class="form-label">Date de naissance</label>
                                <input type="date" class="form-control" id="date_naissance" name="date_naissance">
                            </div>
                        </div>

                        <!-- Coordonnées -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2">
                                    <i class="fas fa-address-book me-2"></i>Coordonnées
                                </h6>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="telephone" class="form-label">Téléphone *</label>
                                <input type="tel" class="form-control" id="telephone" name="telephone" 
                                       required placeholder="+33 1 23 45 67 89">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email" 
                                       placeholder="jean.dupont@email.com">
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label for="adresse" class="form-label">Adresse</label>
                                <textarea class="form-control" id="adresse" name="adresse" 
                                          rows="2" placeholder="123 Avenue de la République, 75001 Paris"></textarea>
                            </div>
                        </div>

                        <!-- Informations mutuelle -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2">
                                    <i class="fas fa-shield-alt me-2"></i>Informations Mutuelle
                                </h6>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="categorie" class="form-label">Catégorie *</label>
                                <select class="form-select" id="categorie" name="categorie" required>
                                    <option value="">Choisir une catégorie...</option>
                                    <option value="INDIVIDUEL">Individuel</option>
                                    <option value="FAMILLE">Famille</option>
                                    <option value="ETUDIANT">Étudiant</option>
                                    <option value="SENIOR">Sénior</option>
                                    <option value="ENTREPRISE">Entreprise</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="date_inscription" class="form-label">Date d'inscription *</label>
                                <input type="date" class="form-control" id="date_inscription" 
                                       name="date_inscription" required value="{{ date_aujourdhui }}">
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="statut" class="form-label">Statut *</label>
                                <select class="form-select" id="statut" name="statut" required>
                                    <option value="AC">Actif</option>
                                    <option value="IN">Inactif</option>
                                    <option value="RE">En retard</option>
                                    <option value="SU">Suspendu</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="numero_securite_sociale" class="form-label">Numéro de sécurité sociale</label>
                                <input type="text" class="form-control" id="numero_securite_sociale" 
                                       name="numero_securite_sociale" placeholder="1 85 08 75 123 456 78">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="profession" class="form-label">Profession</label>
                                <input type="text" class="form-control" id="profession" name="profession" 
                                       placeholder="Ingénieur, Enseignant, etc.">
                            </div>
                        </div>

                        <!-- Informations médicales -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2">
                                    <i class="fas fa-heartbeat me-2"></i>Informations Médicales
                                </h6>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="groupe_sanguin" class="form-label">Groupe sanguin</label>
                                <select class="form-select" id="groupe_sanguin" name="groupe_sanguin">
                                    <option value="">Non spécifié</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="medecin_traitant" class="form-label">Médecin traitant</label>
                                <input type="text" class="form-control" id="medecin_traitant" 
                                       name="medecin_traitant" placeholder="Dr. Martin">
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label for="allergies" class="form-label">Allergies connues</label>
                                <textarea class="form-control" id="allergies" name="allergies" 
                                          rows="2" placeholder="Pénicilline, Arachides, etc."></textarea>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label for="traitements" class="form-label">Traitements en cours</label>
                                <textarea class="form-control" id="traitements" name="traitements" 
                                          rows="2" placeholder="Médicaments réguliers..."></textarea>
                            </div>
                        </div>

                        <!-- Informations d'urgence -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2">
                                    <i class="fas fa-phone-alt me-2"></i>Contact d'urgence
                                </h6>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="contact_urgence_nom" class="form-label">Nom du contact</label>
                                <input type="text" class="form-control" id="contact_urgence_nom" 
                                       name="contact_urgence_nom" placeholder="Marie Dupont">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="contact_urgence_telephone" class="form-label">Téléphone d'urgence</label>
                                <input type="tel" class="form-control" id="contact_urgence_telephone" 
                                       name="contact_urgence_telephone" placeholder="+33 1 23 45 67 89">
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label for="contact_urgence_lien" class="form-label">Lien avec le membre</label>
                                <input type="text" class="form-control" id="contact_urgence_lien" 
                                       name="contact_urgence_lien" placeholder="Épouse, Parent, etc.">
                            </div>
                        </div>

                        <!-- Résumé -->
                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="fas fa-info-circle me-1"></i>Résumé du membre
                            </h6>
                            <div id="resumeMembre" class="mb-0">
                                Renseignez les informations ci-dessus pour voir le résumé...
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'assureur:recherche_membre' %}" 
                               class="btn btn-outline-secondary me-md-2">
                                Annuler
                            </a>
                            <button type="submit" class="btn btn-primary" id="btnSubmit">
                                <i class="fas fa-save me-1"></i> Créer le membre
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Aide -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-question-circle me-1"></i>Informations importantes
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>Les champs marqués d'un * sont obligatoires</li>
                        <li><i class="fas fa-check text-success me-2"></i>Le numéro unique sera généré automatiquement</li>
                        <li><i class="fas fa-check text-success me-2"></i>Vérifiez les coordonnées avant validation</li>
                        <li><i class="fas fa-check text-success me-2"></i>Le membre recevra un email de bienvenue</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('formCreerMembre');
    const resumeDiv = document.getElementById('resumeMembre');
    
    function updateResume() {
        const nom = document.getElementById('nom').value || 'Non renseigné';
        const prenom = document.getElementById('prenom').value || 'Non renseigné';
        const telephone = document.getElementById('telephone').value || 'Non renseigné';
        const categorie = document.getElementById('categorie').options[document.getElementById('categorie').selectedIndex]?.text || 'Non spécifiée';
        const statut = document.getElementById('statut').options[document.getElementById('statut').selectedIndex]?.text || 'Non spécifié';
        
        resumeDiv.innerHTML = `
            <strong>Nom complet:</strong> ${prenom} ${nom}<br>
            <strong>Téléphone:</strong> ${telephone}<br>
            <strong>Catégorie:</strong> ${categorie}<br>
            <strong>Statut:</strong> ${statut}<br>
            <strong>Date d'inscription:</strong> ${document.getElementById('date_inscription').value || 'Aujourd\'hui'}
        `;
    }
    
    // Écouter les changements sur les champs importants
    const fieldsToWatch = ['nom', 'prenom', 'telephone', 'categorie', 'statut', 'date_inscription'];
    fieldsToWatch.forEach(fieldId => {
        document.getElementById(fieldId).addEventListener('input', updateResume);
        document.getElementById(fieldId).addEventListener('change', updateResume);
    });
    
    // Mise à jour initiale
    updateResume();
    
    // Validation du formulaire
    form.addEventListener('submit', function(e) {
        const telephone = document.getElementById('telephone').value;
        if (telephone && telephone.length < 8) {
            e.preventDefault();
            alert('Le numéro de téléphone doit contenir au moins 8 caractères');
            document.getElementById('telephone').focus();
            return;
        }
        
        // Désactiver le bouton pendant l'envoi
        const btnSubmit = document.getElementById('btnSubmit');
        btnSubmit.disabled = true;
        btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Création en cours...';
    });
});

// Génération automatique de la date d'aujourd'hui
document.getElementById('date_inscription').value = new Date().toISOString().split('T')[0];
</script>
{% endblock %}