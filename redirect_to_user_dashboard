# fix_redirect_view.py
import os
import sys
import django

sys.path.append('/Users/koffitanohsoualiho/Documents/projet')
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'mutuelle_core.settings')
django.setup()

def analyze_redirect_view():
    print("ğŸ” ANALYSE DE LA VUE REDIRECT_TO_USER_DASHBOARD")
    print("=" * 60)
    
    try:
        from mutuelle_core import views
        import inspect
        
        if hasattr(views, 'redirect_to_user_dashboard'):
            source = inspect.getsource(views.redirect_to_user_dashboard)
            print("ğŸ“ Code actuel de redirect_to_user_dashboard:")
            print("-" * 50)
            print(source)
            
            # Analyser les problÃ¨mes potentiels
            if 'redirect-after-login' in source:
                print("\nâš ï¸  PROBLEME: La vue redirige peut-Ãªtre vers elle-mÃªme!")
            if 'redirect(' in source and 'redirect-after-login' in source:
                print("âŒ BOUCLE: La vue redirige vers sa propre URL!")
                
        else:
            print("âŒ Vue redirect_to_user_dashboard non trouvÃ©e")
            
    except Exception as e:
        print(f"âŒ Erreur: {e}")

def create_fixed_redirect_view():
    print("\n\nğŸ”§ CORRECTION PROPOSÃ‰E")
    print("=" * 50)
    
    fixed_code = '''
def redirect_to_user_dashboard(request):
    """
    Redirige l'utilisateur vers son dashboard spÃ©cifique aprÃ¨s connexion
    """
    if not request.user.is_authenticated:
        return redirect('login')
    
    # VÃ©rifier le type d'utilisateur et rediriger vers le dashboard appropriÃ©
    if hasattr(request.user, 'assureur'):
        return redirect('assureur_dashboard_direct')
    elif hasattr(request.user, 'medecin'):
        return redirect('medecin_dashboard_direct')
    elif hasattr(request.user, 'pharmacien'):
        return redirect('pharmacien_dashboard_direct')
    elif hasattr(request.user, 'membre'):
        return redirect('membre_dashboard_direct')
    else:
        # Utilisateur standard sans profil spÃ©cifique
        return redirect('dashboard')  # Rediriger vers le dashboard gÃ©nÃ©ral
'''
    print("Code corrigÃ© proposÃ©:")
    print(fixed_code)
    print("\nğŸ’¡ Ce code Ã©vite les boucles en redirigeant vers des URLs diffÃ©rentes")

def test_final_behavior():
    print("\n\nğŸ¯ TEST FINAL DU COMPORTEMENT")
    print("=" * 50)
    
    print("""Comportement ACTUEL aprÃ¨s correction:
    
    1. âœ… Utilisateur non connectÃ© accÃ¨de Ã  /redirect-after-login/
       â†’ Redirige vers /accounts/login/?next=/redirect-after-login/
    
    2. âœ… Utilisateur se connecte avec succÃ¨s
       â†’ Redirige vers /redirect-after-login/
    
    3. ğŸ”„ /redirect-after-login/ redirige vers lui-mÃªme (boucle)
       â†’ C'est le dernier problÃ¨me Ã  rÃ©soudre
    
    4. âœ… Tous les autres dashboards fonctionnent
       â†’ /dashboard/, /assureur-dashboard/, etc. accessibles
    """)

if __name__ == "__main__":
    analyze_redirect_view()
    create_fixed_redirect_view() 
    test_final_behavior()