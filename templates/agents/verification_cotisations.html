{% extends 'agents/base_agent.html' %}
{% load humanize %}

{% block title %}Vérification des Cotisations - Agents{% endblock %}
{% block page_icon %}clipboard-check{% endblock %}
{% block page_title %}Vérification des Cotisations{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- En-tête -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-2">
                <i class="fas fa-clipboard-check text-primary me-2"></i>
                Vérification des Cotisations
            </h1>
            <p class="mb-0">Vérifiez l'état des cotisations de vos membres assignés</p>
        </div>
        
        <!-- Statistiques rapides -->
        <div class="d-flex gap-3">
            <div class="text-center">
                <div class="text-muted small">Total Membres</div>
                <div class="h4 mb-0 text-primary">{{ total_membres|default:"0" }}</div>
            </div>
            <div class="text-center">
                <div class="text-muted small">À jour</div>
                <div class="h4 mb-0 text-success">{{ membres_a_jour|default:"0" }}</div>
            </div>
            <div class="text-center">
                <div class="text-muted small">En retard</div>
                <div class="h4 mb-0 text-danger">{{ membres_en_retard|default:"0" }}</div>
            </div>
            <div class="text-center">
                <div class="text-muted small">Conformité</div>
                <div class="h4 mb-0 text-info">
                    {% if taux_conformite %}
                        {{ taux_conformite|floatformat:1 }}%
                    {% else %}
                        0%
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Statut</label>
                    <select name="statut" class="form-select">
                        <option value="">Tous les statuts</option>
                        <option value="a_jour" {% if request.GET.statut == 'a_jour' %}selected{% endif %}>À jour</option>
                        <option value="non_a_jour" {% if request.GET.statut == 'non_a_jour' %}selected{% endif %}>Non à jour</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Recherche</label>
                    <div class="input-group">
                        <input type="text" name="search" class="form-control" 
                               placeholder="Nom, prénom, téléphone..." value="{{ request.GET.search|default:'' }}">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <a href="{% url 'agents:verification_cotisations' %}" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-redo"></i> Réinitialiser
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Liste des membres -->
    <div class="card shadow">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">
                Membres Assignés ({{ total_membres|default:"0" }})
            </h6>
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" onclick="window.print()">
                    <i class="fas fa-print"></i> Imprimer
                </button>
                <!-- Commenté jusqu'à ce que l'export soit implémenté -->
                <!-- <a href="#" class="btn btn-sm btn-outline-success">
                    <i class="fas fa-download"></i> Exporter
                </a> -->
            </div>
        </div>
        
        <div class="card-body">
            {% if membres %}
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="dataTable">
                    <thead class="bg-light">
                        <tr>
                            <th>#</th>
                            <th>Membre</th>
                            <th>Contact</th>
                            <th>Statut Cotisation</th>
                            <th>Dernière Cotisation</th>
                            <th>Prochaine Échéance</th>
                            <th>Jours Restants/Retard</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for membre in membres %}
                        <tr class="{% if not membre.est_a_jour %}table-danger{% endif %}">
                            <td>{{ forloop.counter }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar bg-primary text-white rounded-circle me-2" 
                                         style="width: 32px; height: 32px; line-height: 32px; text-align: center;">
                                        {{ membre.nom|first|upper }}{{ membre.prenom|first|upper }}
                                    </div>
                                    <div>
                                        <strong>{{ membre.prenom }} {{ membre.nom }}</strong><br>
                                        <small class="text-muted">#{{ membre.numero_unique|default:"N/A" }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="small">
                                    <div><i class="fas fa-phone text-muted me-1"></i> {{ membre.telephone|default:"-" }}</div>
                                    <div><i class="fas fa-envelope text-muted me-1"></i> {{ membre.email|default:"-" }}</div>
                                </div>
                            </td>
                            <td>
                                {% if membre.est_a_jour %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle"></i> À jour
                                </span>
                                {% else %}
                                <span class="badge bg-danger">
                                    <i class="fas fa-exclamation-triangle"></i> En retard
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if membre.derniere_cotisation_payee %}
                                    <div class="text-success">
                                        <i class="fas fa-check-circle"></i> 
                                        {{ membre.derniere_cotisation_payee.montant|intcomma|default:"0" }} FCFA
                                    </div>
                                    <small class="text-muted">{{ membre.derniere_cotisation_payee.date_paiement|date:"d/m/Y"|default:"-" }}</small>
                                {% else %}
                                    <span class="text-danger">Aucun paiement</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if membre.est_a_jour %}
                                    {% if membre.prochaine_echeance %}
                                        <span class="text-success">{{ membre.prochaine_echeance|date:"d/m/Y" }}</span>
                                    {% else %}
                                        <span class="text-warning">Non définie</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-danger">Immediate</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if membre.est_a_jour %}
                                    {% if membre.jours_avant_echeance %}
                                        {% if membre.jours_avant_echeance > 0 %}
                                        <span class="text-success">
                                            <i class="fas fa-clock"></i> {{ membre.jours_avant_echeance }} jour{{ membre.jours_avant_echeance|pluralize:"s" }}
                                        </span>
                                        {% else %}
                                        <span class="text-warning">
                                            <i class="fas fa-exclamation-circle"></i> Échéance aujourd'hui
                                        </span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                {% else %}
                                    {% if membre.jours_en_retard %}
                                        <span class="text-danger">
                                            <i class="fas fa-clock"></i> {{ membre.jours_en_retard }} jour{{ membre.jours_en_retard|pluralize:"s" }} de retard
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <!-- Commenté jusqu'à ce que la vue soit implémentée -->
                                    <!-- <a href="#" class="btn btn-outline-primary" title="Détails">
                                        <i class="fas fa-eye"></i>
                                    </a> -->
                                    <button class="btn btn-outline-info verifier-btn" 
                                            data-membre-id="{{ membre.id }}"
                                            data-membre-nom="{{ membre.prenom }} {{ membre.nom }}"
                                            title="Vérifier">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                    <button class="btn btn-outline-warning rappel-btn" 
                                            data-membre-id="{{ membre.id }}"
                                            data-membre-nom="{{ membre.prenom }} {{ membre.nom }}"
                                            title="Envoyer rappel">
                                        <i class="fas fa-bell"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Résumé -->
            <div class="alert alert-info mt-3">
                <div class="row">
                    <div class="col-md-6">
                        <i class="fas fa-info-circle"></i>
                        <strong>Résumé :</strong>
                        <span class="badge bg-success">{{ membres_a_jour|default:"0" }} membres à jour</span>
                        <span class="badge bg-danger">{{ membres_en_retard|default:"0" }} membres en retard</span>
                    </div>
                    <div class="col-md-6 text-end">
                        <small>Dernière mise à jour : {% now "d/m/Y H:i" %}</small>
                    </div>
                </div>
            </div>
            
            {% else %}
            <div class="text-center py-5">
                <div class="empty-state">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h4>Aucun membre trouvé</h4>
                    <p class="text-muted">Aucun membre ne correspond à vos critères de recherche.</p>
                    <div class="mt-3">
                        <a href="{% url 'agents:creer_membre' %}" class="btn btn-primary me-2">
                            <i class="fas fa-user-plus"></i> Créer un membre
                        </a>
                        <a href="{% url 'agents:verification_cotisations' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-redo"></i> Afficher tous les membres
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal de vérification -->
<div class="modal fade" id="verificationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-check-circle"></i> Résultat de la vérification</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="verificationResult">
                <!-- Le résultat sera inséré ici -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" id="printResultBtn">
                    <i class="fas fa-print"></i> Imprimer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de rappel -->
<div class="modal fade" id="rappelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title"><i class="fas fa-bell"></i> Envoyer un rappel</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="rappelBody">
                <!-- Le contenu sera inséré ici -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-warning" id="confirmerRappelBtn">
                    <i class="fas fa-paper-plane"></i> Envoyer
                </button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// Script pour la vérification des cotisations
document.addEventListener('DOMContentLoaded', function() {
    // Vérification via bouton
    document.querySelectorAll('.verifier-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const membreId = this.getAttribute('data-membre-id');
            const membreNom = this.getAttribute('data-membre-nom');
            
            // Simuler une vérification (à remplacer par un appel API réel)
            const resultHTML = `
                <div class="alert alert-info">
                    <h5>Vérification pour : ${membreNom}</h5>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <strong>Dernier paiement:</strong><br>
                            15,000 FCFA (le 15/01/2024)
                        </div>
                        <div class="col-6">
                            <strong>Prochaine échéance:</strong><br>
                            15/02/2024
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <strong>Statut:</strong> 
                            <span class="badge bg-success">À jour</span><br>
                            <strong>Jours restants:</strong> 12 jours<br>
                            <strong>Historique des paiements:</strong>
                            <ul class="small">
                                <li>Janvier 2024: 15,000 FCFA ✓</li>
                                <li>Décembre 2023: 15,000 FCFA ✓</li>
                                <li>Novembre 2023: 15,000 FCFA ✓</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('verificationResult').innerHTML = resultHTML;
            
            // Afficher le modal
            const modal = new bootstrap.Modal(document.getElementById('verificationModal'));
            modal.show();
        });
    });
    
    // Bouton d'impression
    document.getElementById('printResultBtn')?.addEventListener('click', function() {
        window.print();
    });
    
    // Gestion des rappels
    document.querySelectorAll('.rappel-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const membreId = this.getAttribute('data-membre-id');
            const membreNom = this.getAttribute('data-membre-nom');
            
            const rappelHTML = `
                <p>Êtes-vous sûr de vouloir envoyer un rappel de cotisation à :</p>
                <div class="alert alert-warning">
                    <strong>${membreNom}</strong> (ID: ${membreId})
                </div>
                <p>Un SMS ou un email sera envoyé pour rappeler la cotisation.</p>
                <div class="mb-3">
                    <label class="form-label">Message personnalisé (optionnel):</label>
                    <textarea class="form-control" rows="3" id="messagePersonnalise" 
                              placeholder="Cher(e) membre, votre cotisation est due..."></textarea>
                </div>
            `;
            
            document.getElementById('rappelBody').innerHTML = rappelHTML;
            
            // Mettre à jour le bouton de confirmation
            document.getElementById('confirmerRappelBtn').onclick = function() {
                const message = document.getElementById('messagePersonnalise')?.value || '';
                envoyerRappel(membreId, membreNom, message);
            };
            
            // Afficher le modal
            const modal = new bootstrap.Modal(document.getElementById('rappelModal'));
            modal.show();
        });
    });
    
    // Fonction d'envoi de rappel
    function envoyerRappel(membreId, membreNom, message) {
        // Simuler l'envoi (à remplacer par un appel API réel)
        console.log(`Envoi rappel à ${membreNom} (ID: ${membreId})`);
        console.log(`Message: ${message}`);
        
        // Fermer le modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('rappelModal'));
        modal.hide();
        
        // Afficher une notification
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show';
        alertDiv.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <strong>Rappel envoyé !</strong> Le membre ${membreNom} a été notifié.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Ajouter l'alerte en haut de la page
        const mainContent = document.querySelector('main');
        if (mainContent) {
            mainContent.insertBefore(alertDiv, mainContent.firstChild);
            
            // Auto-dismiss après 5 secondes
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alertDiv);
                bsAlert.close();
            }, 5000);
        }
    }
    
    // Filtrer le tableau avec la recherche
    const searchInput = document.querySelector('input[name="search"]');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('#dataTable tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
    }
});
</script>

<style>
.avatar {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

.empty-state {
    padding: 3rem 1rem;
}

.badge {
    font-weight: 500;
    padding: 0.4em 0.8em;
}

#dataTable th {
    font-weight: 600;
    color: #495057;
    background-color: #f8f9fa;
}

.table-danger {
    background-color: rgba(220, 53, 69, 0.05);
}

/* Style pour l'impression */
@media print {
    .sidebar, .navbar, .card-header .btn-group, .modal {
        display: none !important;
    }
    
    .col-md-9, .col-lg-10 {
        width: 100% !important;
        max-width: 100% !important;
        flex: 0 0 100% !important;
    }
    
    .main-content {
        padding: 0 !important;
    }
    
    .card {
        border: none !important;
        box-shadow: none !important;
    }
    
    .card-body {
        padding: 0 !important;
    }
    
    table {
        width: 100% !important;
        font-size: 12px !important;
    }
}
</style>
{% endblock %}
{% endblock %}