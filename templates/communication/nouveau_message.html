{% extends "agents/base_agent.html" %}
{% load static %}

{% block title %}Nouveau Message - Communication{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-envelope me-2 text-primary"></i>
            Nouveau Message
        </h1>
        <a href="{% url 'communication:messagerie' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Retour
        </a>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-paper-plane me-2"></i>
                        Rédiger un nouveau message
                    </h5>
                </div>
                <div class="card-body">
                    <form id="new-message-form" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- Destinataire -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Destinataire</label>
                            <select class="form-select" id="destinataire" name="destinataire" required>
                                <option value="">Sélectionner un destinataire...</option>
                                <optgroup label="Médecins">
                                    <!-- Rempli dynamiquement -->
                                </optgroup>
                                <optgroup label="Agents">
                                    <!-- Rempli dynamiquement -->
                                </optgroup>
                                <optgroup label="Pharmaciens">
                                    <!-- Rempli dynamiquement -->
                                </optgroup>
                            </select>
                            <div class="form-text">
                                Sélectionnez la personne à qui vous souhaitez envoyer ce message
                            </div>
                        </div>

                        <!-- Sujet -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Sujet</label>
                            <input type="text" class="form-control" id="sujet" name="sujet" 
                                   placeholder="Objet du message..." required>
                        </div>

                        <!-- Message -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Message</label>
                            <textarea class="form-control" id="message" name="message" 
                                      rows="8" placeholder="Tapez votre message ici..." 
                                      required></textarea>
                            <div class="form-text">
                                <span id="char-count">0</span> caractères
                            </div>
                        </div>

                        <!-- Pièces jointes -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Pièces jointes</label>
                            <div class="border rounded p-3 bg-light">
                                <div class="mb-3">
                                    <input type="file" class="form-control" id="pieces-jointes" 
                                           name="pieces_jointes" multiple 
                                           accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.txt,.zip">
                                    <div class="form-text">
                                        Formats acceptés: PDF, Word, Excel, images, texte, archives (max 10MB par fichier)
                                    </div>
                                </div>
                                
                                <!-- Aperçu des fichiers -->
                                <div id="fichiers-preview" class="mt-3" style="display: none;">
                                    <h6 class="text-muted mb-2">Fichiers sélectionnés:</h6>
                                    <div id="fichiers-liste" class="list-group"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Options -->
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="confirmation-lecture" name="confirmation_lecture">
                                <label class="form-check-label" for="confirmation-lecture">
                                    Demander une confirmation de lecture
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="urgent" name="urgent">
                                <label class="form-check-label text-danger" for="urgent">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Marquer comme urgent
                                </label>
                            </div>
                        </div>

                        <!-- Boutons d'action -->
                        <div class="d-flex gap-2 justify-content-end">
                            <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                                <i class="fas fa-times me-1"></i>Annuler
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="btn-brouillon">
                                <i class="fas fa-save me-1"></i>Enregistrer brouillon
                            </button>
                            <button type="submit" class="btn btn-primary" id="btn-envoyer">
                                <i class="fas fa-paper-plane me-1"></i>Envoyer le message
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Guide -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Guide de communication
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Bonnes pratiques:</h6>
                            <ul class="small">
                                <li>Soyez clair et concis dans votre message</li>
                                <li>Utilisez un sujet descriptif</li>
                                <li>Vérifiez l'orthographe</li>
                                <li>Joignez les documents nécessaires</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Destinataires disponibles:</h6>
                            <ul class="small">
                                <li><strong>Médecins:</strong> Pour les questions médicales</li>
                                <li><strong>Agents:</strong> Pour la coordination interne</li>
                                <li><strong>Pharmaciens:</strong> Pour les ordonnances</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let fichiersSelectionnes = [];

// Charger la liste des destinataires
function loadDestinataires() {
    fetch('/communication/api/destinataires/')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('destinataire');
            const groupes = {
                'Médecins': data.medecins || [],
                'Agents': data.agents || [],
                'Pharmaciens': data.pharmaciens || []
            };

            // Vider les options existantes (garder la première)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }

            // Ajouter les nouveaux groupes
            Object.entries(groupes).forEach(([groupeName, items]) => {
                if (items.length > 0) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = groupeName;
                    
                    items.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = `${item.nom} - ${item.role || item.specialite || ''}`;
                        optgroup.appendChild(option);
                    });
                    
                    select.appendChild(optgroup);
                }
            });
        })
        .catch(error => {
            console.error('Erreur chargement destinataires:', error);
        });
}

// Gestion des pièces jointes
document.getElementById('pieces-jointes').addEventListener('change', function(e) {
    fichiersSelectionnes = Array.from(e.target.files);
    afficherApercuFichiers();
});

function afficherApercuFichiers() {
    const container = document.getElementById('fichiers-preview');
    const liste = document.getElementById('fichiers-liste');
    
    liste.innerHTML = '';
    
    if (fichiersSelectionnes.length === 0) {
        container.style.display = 'none';
        return;
    }
    
    fichiersSelectionnes.forEach((fichier, index) => {
        const div = document.createElement('div');
        div.className = 'list-group-item d-flex justify-content-between align-items-center';
        div.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="${getFileIcon(fichier)} me-2 text-primary"></i>
                <div>
                    <div class="small">${fichier.name}</div>
                    <div class="extra-small text-muted">${formatTaille(fichier.size)}</div>
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="supprimerFichier(${index})">
                <i class="fas fa-times"></i>
            </button>
        `;
        liste.appendChild(div);
    });
    
    container.style.display = 'block';
}

function supprimerFichier(index) {
    fichiersSelectionnes.splice(index, 1);
    
    // Mettre à jour l'input file
    const dataTransfer = new DataTransfer();
    fichiersSelectionnes.forEach(fichier => dataTransfer.items.add(fichier));
    document.getElementById('pieces-jointes').files = dataTransfer.files;
    
    afficherApercuFichiers();
}

function getFileIcon(file) {
    const extension = file.name.split('.').pop().toLowerCase();
    const icons = {
        'pdf': 'fas fa-file-pdf',
        'doc': 'fas fa-file-word',
        'docx': 'fas fa-file-word',
        'xls': 'fas fa-file-excel',
        'xlsx': 'fas fa-file-excel',
        'jpg': 'fas fa-file-image',
        'jpeg': 'fas fa-file-image',
        'png': 'fas fa-file-image',
        'txt': 'fas fa-file-alt',
        'zip': 'fas fa-file-archive'
    };
    return icons[extension] || 'fas fa-file';
}

function formatTaille(bytes) {
    if (bytes < 1024) return bytes + ' o';
    else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' Ko';
    else return (bytes / 1048576).toFixed(1) + ' Mo';
}

// Compteur de caractères
document.getElementById('message').addEventListener('input', function(e) {
    document.getElementById('char-count').textContent = e.target.value.length;
});

// Envoi du formulaire
document.getElementById('new-message-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('destinataire', document.getElementById('destinataire').value);
    formData.append('sujet', document.getElementById('sujet').value);
    formData.append('message', document.getElementById('message').value);
    formData.append('confirmation_lecture', document.getElementById('confirmation-lecture').checked);
    formData.append('urgent', document.getElementById('urgent').checked);
    
    // Ajouter les fichiers
    fichiersSelectionnes.forEach(fichier => {
        formData.append('pieces_jointes', fichier);
    });
    
    // Désactiver le bouton
    const btn = document.getElementById('btn-envoyer');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Envoi...';
    
    fetch('/communication/api/envoyer-message/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Message envoyé avec succès!', 'success');
            setTimeout(() => {
                window.location.href = '{% url "communication:messagerie" %}';
            }, 1500);
        } else {
            showAlert('Erreur: ' + (data.error || 'Échec de l\'envoi'), 'danger');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Envoyer le message';
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showAlert('Erreur de connexion', 'danger');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Envoyer le message';
    });
});

// Sauvegarde brouillon
document.getElementById('btn-brouillon').addEventListener('click', function() {
    // Implémentation de la sauvegarde en brouillon
    showAlert('Fonctionnalité brouillon à implémenter', 'info');
});

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.card-body').prepend(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, 5000);
}

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    loadDestinataires();
});
</script>
{% endblock %}