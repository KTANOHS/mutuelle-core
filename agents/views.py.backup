# agents/views.py - VERSION AVEC VOS MODÈLES EXISTANTS
from django.shortcuts import render, get_object_or_404
from django.http import JsonResponse
from django.contrib.auth.decorators import login_required
from django.db.models import Q
from django.utils import timezone
from datetime import datetime, timedelta
import json

# Import de vos modèles existants
from membres.models import Membre
from paiements.models import Paiement
from .models import Agent, VerificationCotisation, ActiviteAgent, BonSoin

@login_required
def verification_cotisations(request):
    """Page principale de vérification des cotisations"""
    
    # Récupérer l'agent connecté
    try:
        agent = Agent.objects.get(user=request.user)
    except Agent.DoesNotExist:
        # Si l'utilisateur n'est pas un agent, rediriger ou afficher une erreur
        return render(request, 'agents/error.html', {
            'message': 'Accès réservé aux agents'
        })
    
    # Statistiques réelles
    aujourd_hui = timezone.now().date()
    verifications_du_jour = VerificationCotisation.objects.filter(
        agent=agent,
        date_verification__date=aujourd_hui
    ).count()
    
    # Dernières vérifications
    dernieres_verifications = VerificationCotisation.objects.filter(
        agent=agent
    ).select_related('membre').order_by('-date_verification')[:10]
    
    context = {
        'agent': agent,
        'verifications_du_jour': verifications_du_jour,
        'dernieres_verifications': dernieres_verifications,
    }
    
    return render(request, 'agents/verification_cotisations.html', context)

@login_required
def recherche_membres_api(request):
    """API pour la recherche de membres - AVEC MODÈLES EXISTANTS"""
    query = request.GET.get('q', '').strip()
    
    if len(query) < 2:
        return JsonResponse({'membres': []})
    
    try:
        # Récupérer l'agent connecté
        agent = Agent.objects.get(user=request.user)
        
        # Recherche dans la base de données avec vos modèles
        membres = Membre.objects.filter(
            Q(nom__icontains=query) | 
            Q(prenom__icontains=query) |
            Q(numero_membre__icontains=query) |
            Q(telephone__icontains=query)
        )[:10]  # Limite à 10 résultats
        
        results = []
        for membre in membres:
            # Déterminer si le membre est à jour
            est_a_jour, details = verifier_cotisation_membre(membre)
            
            results.append({
                'id': membre.id,
                'nom_complet': f"{membre.prenom} {membre.nom}",
                'numero_membre': membre.numero_membre,
                'telephone': membre.telephone or 'Non renseigné',
                'est_a_jour': est_a_jour,
            })
        
        # Enregistrer l'activité
        ActiviteAgent.objects.create(
            agent=agent,
            type_activite='consultation_membre',
            description=f"Recherche de membres: '{query}' - {len(results)} résultats",
            donnees_concernees={
                'query': query,
                'resultats': len(results)
            },
            ip_address=get_client_ip(request)
        )
        
        return JsonResponse({'membres': results})
        
    except Agent.DoesNotExist:
        return JsonResponse({'error': 'Accès non autorisé'}, status=403)
    except Exception as e:
        return JsonResponse({'error': str(e)}, status=500)

@login_required
def verifier_cotisation_api(request, membre_id):
    """API pour vérifier la cotisation d'un membre - AVEC MODÈLES EXISTANTS"""
    try:
        # Récupérer l'agent connecté
        agent = Agent.objects.get(user=request.user)
        
        # Récupérer le membre
        membre = get_object_or_404(Membre, id=membre_id)
        
        # Vérifier le statut de cotisation réel
        est_a_jour, details = verifier_cotisation_membre_detaille(membre)
        
        # Déterminer le statut pour le modèle VerificationCotisation
        if est_a_jour:
            statut_cotisation = 'a_jour'
        elif details.get('jours_retard', 0) > 30:
            statut_cotisation = 'impayee'
        else:
            statut_cotisation = 'en_retard'
        
        # Enregistrer la vérification
        verification = VerificationCotisation.objects.create(
            agent=agent,
            membre=membre,
            statut_cotisation=statut_cotisation,
            date_dernier_paiement=details.get('date_dernier_paiement'),
            montant_dernier_paiement=details.get('montant_dernier_paiement'),
            prochaine_echeance=details.get('prochaine_echeance'),
            jours_retard=details.get('jours_retard', 0),
            montant_dette=details.get('montant_dette', 0),
            observations=details.get('message', '')
        )
        
        response_data = {
            'success': True,
            'est_a_jour': est_a_jour,
            'message': details.get('message', 'Statut vérifié'),
            'prochaine_echeance': details.get('prochaine_echeance_str'),
            'dernier_paiement': details.get('dernier_paiement_str'),
            'montant_du': details.get('montant_dette_str', '0 FCFA'),
            'jours_retard': details.get('jours_retard', 0),
            'verification_id': verification.id,
        }
        
        return JsonResponse(response_data)
            
    except Agent.DoesNotExist:
        return JsonResponse({
            'success': False,
            'error': 'Accès non autorisé'
        }, status=403)
    except Membre.DoesNotExist:
        return JsonResponse({
            'success': False,
            'error': 'Membre non trouvé'
        }, status=404)
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': f'Erreur lors de la vérification: {str(e)}'
        }, status=500)

@login_required
def tableau_de_bord_agent(request):
    """Tableau de bord de l'agent avec données réelles"""
    try:
        agent = Agent.objects.get(user=request.user)
        
        aujourd_hui = timezone.now().date()
        debut_mois = aujourd_hui.replace(day=1)
        
        # Statistiques réelles
        stats = {
            'total_membres': Membre.objects.count(),
            'verifications_mois': VerificationCotisation.objects.filter(
                agent=agent,
                date_verification__date__gte=debut_mois
            ).count(),
            'verifications_semaine': VerificationCotisation.objects.filter(
                agent=agent,
                date_verification__date__gte=aujourd_hui - timedelta(days=7)
            ).count(),
            'bons_crees_mois': BonSoin.objects.filter(
                agent=agent,
                date_creation__date__gte=debut_mois
            ).count(),
            'bons_crees_aujourdhui': BonSoin.objects.filter(
                agent=agent,
                date_creation__date=aujourd_hui
            ).count(),
            'limite_bons': agent.limite_bons_quotidienne,
        }
        
        # Dernières activités
        dernieres_activites = ActiviteAgent.objects.filter(
            agent=agent
        ).order_by('-date_activite')[:10]
        
        # Membres récemment vérifiés
        membres_verifies_recemment = VerificationCotisation.objects.filter(
            agent=agent
        ).select_related('membre').order_by('-date_verification')[:5]
        
        context = {
            'agent': agent,
            'stats': stats,
            'dernieres_activites': dernieres_activites,
            'membres_verifies_recemment': membres_verifies_recemment,
        }
        
        return render(request, 'agents/dashboard.html', context)
        
    except Agent.DoesNotExist:
        return render(request, 'agents/error.html', {
            'message': 'Accès réservé aux agents'
        })

# =============================================================================
# FONCTIONS UTILITAIRES AVEC VOS MODÈLES
# =============================================================================

def verifier_cotisation_membre(membre):
    """Vérification rapide pour la recherche"""
    try:
        # Vérifier via le modèle Paiement
        dernier_paiement = Paiement.objects.filter(
            membre=membre,
            type_paiement='cotisation'
        ).order_by('-date_paiement').first()
        
        if not dernier_paiement:
            return False, {}
        
        # Calculer la date de prochaine échéance (1 an après le paiement)
        date_prochaine = dernier_paiement.date_paiement + timedelta(days=365)
        est_a_jour = timezone.now().date() <= date_prochaine
        
        return est_a_jour, {}
        
    except Exception as e:
        print(f"Erreur vérification rapide {membre}: {e}")
        return False, {}

def verifier_cotisation_membre_detaille(membre):
    """Vérification détaillée pour l'enregistrement"""
    try:
        # Récupérer le dernier paiement de cotisation
        dernier_paiement = Paiement.objects.filter(
            membre=membre,
            type_paiement='cotisation'
        ).order_by('-date_paiement').first()
        
        if not dernier_paiement:
            return False, {
                'message': '❌ Aucune cotisation payée trouvée',
                'date_dernier_paiement': None,
                'montant_dernier_paiement': None,
                'prochaine_echeance': None,
                'jours_retard': 365,  # Considéré comme 1 an de retard si jamais payé
                'montant_dette': 5000,  # Montant standard de cotisation
                'dernier_paiement_str': 'Aucun',
                'prochaine_echeance_str': 'Immédiate',
                'montant_dette_str': '5 000 FCFA',
            }
        
        # Calculer les dates
        date_prochaine = dernier_paiement.date_paiement + timedelta(days=365)
        aujourd_hui = timezone.now().date()
        est_a_jour = aujourd_hui <= date_prochaine
        
        # Calculer le retard
        if aujourd_hui > date_prochaine:
            jours_retard = (aujourd_hui - date_prochaine).days
            montant_dette = 5000  # Cotisation annuelle standard
        else:
            jours_retard = 0
            montant_dette = 0
        
        if est_a_jour:
            return True, {
                'message': '✅ Le membre est à jour dans ses cotisations',
                'date_dernier_paiement': dernier_paiement.date_paiement,
                'montant_dernier_paiement': dernier_paiement.montant,
                'prochaine_echeance': date_prochaine,
                'jours_retard': 0,
                'montant_dette': 0,
                'dernier_paiement_str': dernier_paiement.date_paiement.strftime('%d/%m/%Y'),
                'prochaine_echeance_str': date_prochaine.strftime('%d/%m/%Y'),
                'montant_dette_str': '0 FCFA',
            }
        else:
            return False, {
                'message': f'⚠️ Le membre a {jours_retard} jours de retard',
                'date_dernier_paiement': dernier_paiement.date_paiement,
                'montant_dernier_paiement': dernier_paiement.montant,
                'prochaine_echeance': date_prochaine,
                'jours_retard': jours_retard,
                'montant_dette': montant_dette,
                'dernier_paiement_str': dernier_paiement.date_paiement.strftime('%d/%m/%Y'),
                'prochaine_echeance_str': 'Immédiate',
                'montant_dette_str': f'{montant_dette:,} FCFA'.replace(',', ' '),
            }
            
    except Exception as e:
        print(f"Erreur vérification détaillée {membre}: {e}")
        return False, {
            'message': f'Erreur lors de la vérification: {str(e)}',
            'dernier_paiement_str': 'Erreur',
            'prochaine_echeance_str': 'Erreur',
            'montant_dette_str': 'Erreur',
        }

def get_client_ip(request):
    """Récupère l'adresse IP du client"""
    x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
    if x_forwarded_for:
        ip = x_forwarded_for.split(',')[0]
    else:
        ip = request.META.get('REMOTE_ADDR')
    return ip